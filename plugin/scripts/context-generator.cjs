"use strict";var qn=Object.create;var ke=Object.defineProperty;var jn=Object.getOwnPropertyDescriptor;var Hn=Object.getOwnPropertyNames;var Qn=Object.getPrototypeOf,Gn=Object.prototype.hasOwnProperty;var _e=(s,e)=>()=>(s&&(e=s(s=0)),e);var g=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),bs=(s,e)=>{for(var t in e)ke(s,t,{get:e[t],enumerable:!0})},Rs=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Hn(e))!Gn.call(s,n)&&n!==t&&ke(s,n,{get:()=>e[n],enumerable:!(r=jn(e,n))||r.enumerable});return s};var rt=(s,e,t)=>(t=s!=null?qn(Qn(s)):{},Rs(e||!s||!s.__esModule?ke(t,"default",{value:s,enumerable:!0}):t,s)),Xn=s=>Rs(ke({},"__esModule",{value:!0}),s);var nt,it,As,vs,Cs,Os,ot=_e(()=>{"use strict";nt=["bugfix","feature","refactor","discovery","decision","change"],it=["how-it-works","why-it-exists","what-changed","problem-solution","gotcha","pattern","trade-off"],As={bugfix:"\u{1F534}",feature:"\u{1F7E3}",refactor:"\u{1F504}",change:"\u2705",discovery:"\u{1F535}",decision:"\u2696\uFE0F","session-request":"\u{1F3AF}"},vs={discovery:"\u{1F50D}",change:"\u{1F6E0}\uFE0F",feature:"\u{1F6E0}\uFE0F",bugfix:"\u{1F6E0}\uFE0F",refactor:"\u{1F6E0}\uFE0F",decision:"\u2696\uFE0F"},Cs=nt.join(","),Os=it.join(",")});var at,ct,N,Ee=_e(()=>{"use strict";xe();at=(i=>(i[i.DEBUG=0]="DEBUG",i[i.INFO=1]="INFO",i[i.WARN=2]="WARN",i[i.ERROR=3]="ERROR",i[i.SILENT=4]="SILENT",i))(at||{}),ct=class{level=null;useColor;constructor(){this.useColor=process.stdout.isTTY??!1}getLevel(){if(this.level===null){let e=W.get("CLAUDE_MEM_LOG_LEVEL").toUpperCase();this.level=at[e]??1}return this.level}correlationId(e,t){return`obs-${e}-${t}`}sessionId(e){return`session-${e}`}formatData(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="object"){if(e instanceof Error)return this.getLevel()===0?`${e.message}
${e.stack}`:e.message;if(Array.isArray(e))return`[${e.length} items]`;let t=Object.keys(e);return t.length===0?"{}":t.length<=3?JSON.stringify(e):`{${t.length} keys: ${t.slice(0,3).join(", ")}...}`}return String(e)}formatTool(e,t){if(!t)return e;try{let r=typeof t=="string"?JSON.parse(t):t;if(e==="Bash"&&r.command){let n=r.command.length>50?r.command.substring(0,50)+"...":r.command;return`${e}(${n})`}if(e==="Read"&&r.file_path){let n=r.file_path.split("/").pop()||r.file_path;return`${e}(${n})`}if(e==="Edit"&&r.file_path){let n=r.file_path.split("/").pop()||r.file_path;return`${e}(${n})`}if(e==="Write"&&r.file_path){let n=r.file_path.split("/").pop()||r.file_path;return`${e}(${n})`}return e}catch{return e}}formatTimestamp(e){let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0"),c=String(e.getMilliseconds()).padStart(3,"0");return`${t}-${r}-${n} ${i}:${o}:${a}.${c}`}log(e,t,r,n,i){if(e<this.getLevel())return;let o=this.formatTimestamp(new Date),a=at[e].padEnd(5),c=t.padEnd(6),l="";n?.correlationId?l=`[${n.correlationId}] `:n?.sessionId&&(l=`[session-${n.sessionId}] `);let p="";i!=null&&(this.getLevel()===0&&typeof i=="object"?p=`
`+JSON.stringify(i,null,2):p=" "+this.formatData(i));let f="";if(n){let{sessionId:u,sdkSessionId:y,correlationId:S,...h}=n;Object.keys(h).length>0&&(f=` {${Object.entries(h).map(([L,P])=>`${L}=${P}`).join(", ")}}`)}let _=`[${o}] [${a}] [${c}] ${l}${r}${f}${p}`;e===3?console.error(_):console.log(_)}debug(e,t,r,n){this.log(0,e,t,r,n)}info(e,t,r,n){this.log(1,e,t,r,n)}warn(e,t,r,n){this.log(2,e,t,r,n)}error(e,t,r,n){this.log(3,e,t,r,n)}dataIn(e,t,r,n){this.info(e,`\u2192 ${t}`,r,n)}dataOut(e,t,r,n){this.info(e,`\u2190 ${t}`,r,n)}success(e,t,r,n){this.info(e,`\u2713 ${t}`,r,n)}failure(e,t,r,n){this.error(e,`\u2717 ${t}`,r,n)}timing(e,t,r,n){this.info(e,`\u23F1 ${t}`,n,{duration:`${r}ms`})}happyPathError(e,t,r,n,i=""){let l=((new Error().stack||"").split(`
`)[2]||"").match(/at\s+(?:.*\s+)?\(?([^:]+):(\d+):(\d+)\)?/),p=l?`${l[1].split("/").pop()}:${l[2]}`:"unknown",f={...r,location:p};return this.warn(e,`[HAPPY-PATH] ${t}`,f,n),i}},N=new ct});var ne,Is,ws,W,xe=_e(()=>{"use strict";ne=require("fs"),Is=require("path"),ws=require("os");ot();Ee();W=class{static DEFAULTS={CLAUDE_MEM_MODEL:"claude-sonnet-4-5",CLAUDE_MEM_CONTEXT_OBSERVATIONS:"50",CLAUDE_MEM_WORKER_PORT:"38888",CLAUDE_MEM_WORKER_HOST:"127.0.0.1",CLAUDE_MEM_SKIP_TOOLS:"ListMcpResourcesTool,SlashCommand,Skill,TodoWrite,AskUserQuestion",CLAUDE_MEM_DATABASE:"sqlite",CLAUDE_MEM_DATABASE_URL:"",CLAUDE_MEM_DATA_DIR:(0,Is.join)((0,ws.homedir)(),".claude-mem"),CLAUDE_MEM_LOG_LEVEL:"INFO",CLAUDE_MEM_PYTHON_VERSION:"3.13",CLAUDE_CODE_PATH:"",CLAUDE_MEM_CONTEXT_SHOW_READ_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_WORK_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_AMOUNT:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_PERCENT:"true",CLAUDE_MEM_CONTEXT_OBSERVATION_TYPES:Cs,CLAUDE_MEM_CONTEXT_OBSERVATION_CONCEPTS:Os,CLAUDE_MEM_CONTEXT_FULL_COUNT:"5",CLAUDE_MEM_CONTEXT_FULL_FIELD:"narrative",CLAUDE_MEM_CONTEXT_SESSION_COUNT:"10",CLAUDE_MEM_CONTEXT_SHOW_LAST_SUMMARY:"true",CLAUDE_MEM_CONTEXT_SHOW_LAST_MESSAGE:"false"};static getAllDefaults(){return{...this.DEFAULTS}}static get(e){return this.DEFAULTS[e]}static getInt(e){let t=this.get(e);return parseInt(t,10)}static getBool(e){return this.get(e)==="true"}static loadFromFile(e){if(!(0,ne.existsSync)(e))return this.getAllDefaults();let t=(0,ne.readFileSync)(e,"utf-8"),r=JSON.parse(t),n=r;if(r.env&&typeof r.env=="object"){n=r.env;try{(0,ne.writeFileSync)(e,JSON.stringify(n,null,2),"utf-8"),N.info("SETTINGS","Migrated settings file from nested to flat schema",{settingsPath:e})}catch(o){N.warn("SETTINGS","Failed to auto-migrate settings file",{settingsPath:e},o)}}let i={...this.DEFAULTS};for(let o of Object.keys(this.DEFAULTS))n[o]!==void 0&&(i[o]=n[o]);return i}}});var ht=g($s=>{"use strict";$s.parse=function(s,e){return new pt(s,e).parse()};var pt=class s{constructor(e,t){this.source=e,this.transform=t||Kn,this.position=0,this.entries=[],this.recorded=[],this.dimension=0}isEof(){return this.position>=this.source.length}nextCharacter(){var e=this.source[this.position++];return e==="\\"?{value:this.source[this.position++],escaped:!0}:{value:e,escaped:!1}}record(e){this.recorded.push(e)}newEntry(e){var t;(this.recorded.length>0||e)&&(t=this.recorded.join(""),t==="NULL"&&!e&&(t=null),t!==null&&(t=this.transform(t)),this.entries.push(t),this.recorded=[])}consumeDimensions(){if(this.source[0]==="[")for(;!this.isEof();){var e=this.nextCharacter();if(e.value==="=")break}}parse(e){var t,r,n;for(this.consumeDimensions();!this.isEof();)if(t=this.nextCharacter(),t.value==="{"&&!n)this.dimension++,this.dimension>1&&(r=new s(this.source.substr(this.position-1),this.transform),this.entries.push(r.parse(!0)),this.position+=r.position-2);else if(t.value==="}"&&!n){if(this.dimension--,!this.dimension&&(this.newEntry(),e))return this.entries}else t.value==='"'&&!t.escaped?(n&&this.newEntry(!0),n=!n):t.value===","&&!n?this.newEntry():this.record(t.value);if(this.dimension!==0)throw new Error("array dimension not balanced");return this.entries}};function Kn(s){return s}});var ft=g((Xc,qs)=>{var Jn=ht();qs.exports={create:function(s,e){return{parse:function(){return Jn.parse(s,e)}}}}});var Qs=g((Wc,Hs)=>{"use strict";var zn=/(\d{1,})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})(\.\d{1,})?.*?( BC)?$/,Zn=/^(\d{1,})-(\d{2})-(\d{2})( BC)?$/,ei=/([Z+-])(\d{2})?:?(\d{2})?:?(\d{2})?/,ti=/^-?infinity$/;Hs.exports=function(e){if(ti.test(e))return Number(e.replace("i","I"));var t=zn.exec(e);if(!t)return si(e)||null;var r=!!t[8],n=parseInt(t[1],10);r&&(n=js(n));var i=parseInt(t[2],10)-1,o=t[3],a=parseInt(t[4],10),c=parseInt(t[5],10),l=parseInt(t[6],10),p=t[7];p=p?1e3*parseFloat(p):0;var f,_=ri(e);return _!=null?(f=new Date(Date.UTC(n,i,o,a,c,l,p)),mt(n)&&f.setUTCFullYear(n),_!==0&&f.setTime(f.getTime()-_)):(f=new Date(n,i,o,a,c,l,p),mt(n)&&f.setFullYear(n)),f};function si(s){var e=Zn.exec(s);if(e){var t=parseInt(e[1],10),r=!!e[4];r&&(t=js(t));var n=parseInt(e[2],10)-1,i=e[3],o=new Date(t,n,i);return mt(t)&&o.setFullYear(t),o}}function ri(s){if(s.endsWith("+00"))return 0;var e=ei.exec(s.split(" ")[1]);if(e){var t=e[1];if(t==="Z")return 0;var r=t==="-"?-1:1,n=parseInt(e[2],10)*3600+parseInt(e[3]||0,10)*60+parseInt(e[4]||0,10);return n*r*1e3}}function js(s){return-(s-1)}function mt(s){return s>=0&&s<100}});var Xs=g((Vc,Gs)=>{Gs.exports=ii;var ni=Object.prototype.hasOwnProperty;function ii(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)ni.call(t,r)&&(s[r]=t[r])}return s}});var Ys=g((Yc,Vs)=>{"use strict";var oi=Xs();Vs.exports=ie;function ie(s){if(!(this instanceof ie))return new ie(s);oi(this,gi(s))}var ai=["seconds","minutes","hours","days","months","years"];ie.prototype.toPostgres=function(){var s=ai.filter(this.hasOwnProperty,this);return this.milliseconds&&s.indexOf("seconds")<0&&s.push("seconds"),s.length===0?"0":s.map(function(e){var t=this[e]||0;return e==="seconds"&&this.milliseconds&&(t=(t+this.milliseconds/1e3).toFixed(6).replace(/\.?0+$/,"")),t+" "+e},this).join(" ")};var ci={years:"Y",months:"M",days:"D",hours:"H",minutes:"M",seconds:"S"},ui=["years","months","days"],li=["hours","minutes","seconds"];ie.prototype.toISOString=ie.prototype.toISO=function(){var s=ui.map(t,this).join(""),e=li.map(t,this).join("");return"P"+s+"T"+e;function t(r){var n=this[r]||0;return r==="seconds"&&this.milliseconds&&(n=(n+this.milliseconds/1e3).toFixed(6).replace(/0+$/,"")),n+ci[r]}};var _t="([+-]?\\d+)",di=_t+"\\s+years?",pi=_t+"\\s+mons?",hi=_t+"\\s+days?",fi="([+-])?([\\d]*):(\\d\\d):(\\d\\d)\\.?(\\d{1,6})?",mi=new RegExp([di,pi,hi,fi].map(function(s){return"("+s+")?"}).join("\\s*")),Ws={years:2,months:4,days:6,hours:9,minutes:10,seconds:11,milliseconds:12},_i=["hours","minutes","seconds","milliseconds"];function Ei(s){var e=s+"000000".slice(s.length);return parseInt(e,10)/1e3}function gi(s){if(!s)return{};var e=mi.exec(s),t=e[8]==="-";return Object.keys(Ws).reduce(function(r,n){var i=Ws[n],o=e[i];return!o||(o=n==="milliseconds"?Ei(o):parseInt(o,10),!o)||(t&&~_i.indexOf(n)&&(o*=-1),r[n]=o),r},{})}});var zs=g((Kc,Js)=>{"use strict";var Ks=Buffer.from||Buffer;Js.exports=function(e){if(/^\\x/.test(e))return Ks(e.substr(2),"hex");for(var t="",r=0;r<e.length;)if(e[r]!=="\\")t+=e[r],++r;else if(/[0-7]{3}/.test(e.substr(r+1,3)))t+=String.fromCharCode(parseInt(e.substr(r+1,3),8)),r+=4;else{for(var n=1;r+n<e.length&&e[r+n]==="\\";)n++;for(var i=0;i<Math.floor(n/2);++i)t+="\\";r+=Math.floor(n/2)*2}return Ks(t,"binary")}});var ir=g((Jc,nr)=>{var ge=ht(),Se=ft(),Ue=Qs(),er=Ys(),tr=zs();function Be(s){return function(t){return t===null?t:s(t)}}function sr(s){return s===null?s:s==="TRUE"||s==="t"||s==="true"||s==="y"||s==="yes"||s==="on"||s==="1"}function Si(s){return s?ge.parse(s,sr):null}function yi(s){return parseInt(s,10)}function Et(s){return s?ge.parse(s,Be(yi)):null}function Ti(s){return s?ge.parse(s,Be(function(e){return rr(e).trim()})):null}var bi=function(s){if(!s)return null;var e=Se.create(s,function(t){return t!==null&&(t=Tt(t)),t});return e.parse()},gt=function(s){if(!s)return null;var e=Se.create(s,function(t){return t!==null&&(t=parseFloat(t)),t});return e.parse()},U=function(s){if(!s)return null;var e=Se.create(s);return e.parse()},St=function(s){if(!s)return null;var e=Se.create(s,function(t){return t!==null&&(t=Ue(t)),t});return e.parse()},Ri=function(s){if(!s)return null;var e=Se.create(s,function(t){return t!==null&&(t=er(t)),t});return e.parse()},Ai=function(s){return s?ge.parse(s,Be(tr)):null},yt=function(s){return parseInt(s,10)},rr=function(s){var e=String(s);return/^\d+$/.test(e)?e:s},Zs=function(s){return s?ge.parse(s,Be(JSON.parse)):null},Tt=function(s){return s[0]!=="("?null:(s=s.substring(1,s.length-1).split(","),{x:parseFloat(s[0]),y:parseFloat(s[1])})},vi=function(s){if(s[0]!=="<"&&s[1]!=="(")return null;for(var e="(",t="",r=!1,n=2;n<s.length-1;n++){if(r||(e+=s[n]),s[n]===")"){r=!0;continue}else if(!r)continue;s[n]!==","&&(t+=s[n])}var i=Tt(e);return i.radius=parseFloat(t),i},Ci=function(s){s(20,rr),s(21,yt),s(23,yt),s(26,yt),s(700,parseFloat),s(701,parseFloat),s(16,sr),s(1082,Ue),s(1114,Ue),s(1184,Ue),s(600,Tt),s(651,U),s(718,vi),s(1e3,Si),s(1001,Ai),s(1005,Et),s(1007,Et),s(1028,Et),s(1016,Ti),s(1017,bi),s(1021,gt),s(1022,gt),s(1231,gt),s(1014,U),s(1015,U),s(1008,U),s(1009,U),s(1040,U),s(1041,U),s(1115,St),s(1182,St),s(1185,St),s(1186,er),s(1187,Ri),s(17,tr),s(114,JSON.parse.bind(JSON)),s(3802,JSON.parse.bind(JSON)),s(199,Zs),s(3807,Zs),s(3907,U),s(2951,U),s(791,U),s(1183,U),s(1270,U)};nr.exports={init:Ci}});var ar=g((zc,or)=>{"use strict";var k=1e6;function Oi(s){var e=s.readInt32BE(0),t=s.readUInt32BE(4),r="";e<0&&(e=~e+(t===0),t=~t+1>>>0,r="-");var n="",i,o,a,c,l,p;{if(i=e%k,e=e/k>>>0,o=4294967296*i+t,t=o/k>>>0,a=""+(o-k*t),t===0&&e===0)return r+a+n;for(c="",l=6-a.length,p=0;p<l;p++)c+="0";n=c+a+n}{if(i=e%k,e=e/k>>>0,o=4294967296*i+t,t=o/k>>>0,a=""+(o-k*t),t===0&&e===0)return r+a+n;for(c="",l=6-a.length,p=0;p<l;p++)c+="0";n=c+a+n}{if(i=e%k,e=e/k>>>0,o=4294967296*i+t,t=o/k>>>0,a=""+(o-k*t),t===0&&e===0)return r+a+n;for(c="",l=6-a.length,p=0;p<l;p++)c+="0";n=c+a+n}return i=e%k,o=4294967296*i+t,a=""+o%k,r+a+n}or.exports=Oi});var pr=g((Zc,dr)=>{var Ii=ar(),A=function(s,e,t,r,n){t=t||0,r=r||!1,n=n||function(u,y,S){return u*Math.pow(2,S)+y};var i=t>>3,o=function(u){return r?~u&255:u},a=255,c=8-t%8;e<c&&(a=255<<8-e&255,c=e),t&&(a=a>>t%8);var l=0;t%8+e>=8&&(l=n(0,o(s[i])&a,c));for(var p=e+t>>3,f=i+1;f<p;f++)l=n(l,o(s[f]),8);var _=(e+t)%8;return _>0&&(l=n(l,o(s[p])>>8-_,_)),l},lr=function(s,e,t){var r=Math.pow(2,t-1)-1,n=A(s,1),i=A(s,t,1);if(i===0)return 0;var o=1,a=function(l,p,f){l===0&&(l=1);for(var _=1;_<=f;_++)o/=2,(p&1<<f-_)>0&&(l+=o);return l},c=A(s,e,t+1,!1,a);return i==Math.pow(2,t+1)-1?c===0?n===0?1/0:-1/0:NaN:(n===0?1:-1)*Math.pow(2,i-r)*c},wi=function(s){return A(s,1)==1?-1*(A(s,15,1,!0)+1):A(s,15,1)},cr=function(s){return A(s,1)==1?-1*(A(s,31,1,!0)+1):A(s,31,1)},Li=function(s){return lr(s,23,8)},Ni=function(s){return lr(s,52,11)},Mi=function(s){var e=A(s,16,32);if(e==49152)return NaN;for(var t=Math.pow(1e4,A(s,16,16)),r=0,n=[],i=A(s,16),o=0;o<i;o++)r+=A(s,16,64+16*o)*t,t/=1e4;var a=Math.pow(10,A(s,16,48));return(e===0?1:-1)*Math.round(r*a)/a},ur=function(s,e){var t=A(e,1),r=A(e,63,1),n=new Date((t===0?1:-1)*r/1e3+9466848e5);return s||n.setTime(n.getTime()+n.getTimezoneOffset()*6e4),n.usec=r%1e3,n.getMicroSeconds=function(){return this.usec},n.setMicroSeconds=function(i){this.usec=i},n.getUTCMicroSeconds=function(){return this.usec},n},ye=function(s){for(var e=A(s,32),t=A(s,32,32),r=A(s,32,64),n=96,i=[],o=0;o<e;o++)i[o]=A(s,32,n),n+=32,n+=32;var a=function(l){var p=A(s,32,n);if(n+=32,p==4294967295)return null;var f;if(l==23||l==20)return f=A(s,p*8,n),n+=p*8,f;if(l==25)return f=s.toString(this.encoding,n>>3,(n+=p<<3)>>3),f;console.log("ERROR: ElementType not implemented: "+l)},c=function(l,p){var f=[],_;if(l.length>1){var u=l.shift();for(_=0;_<u;_++)f[_]=c(l,p);l.unshift(u)}else for(_=0;_<l[0];_++)f[_]=a(p);return f};return c(i,r)},Di=function(s){return s.toString("utf8")},ki=function(s){return s===null?null:A(s,8)>0},xi=function(s){s(20,Ii),s(21,wi),s(23,cr),s(26,cr),s(1700,Mi),s(700,Li),s(701,Ni),s(16,ki),s(1114,ur.bind(null,!1)),s(1184,ur.bind(null,!0)),s(1e3,ye),s(1007,ye),s(1016,ye),s(1008,ye),s(1009,ye),s(25,Di)};dr.exports={init:xi}});var fr=g((eu,hr)=>{hr.exports={BOOL:16,BYTEA:17,CHAR:18,INT8:20,INT2:21,INT4:23,REGPROC:24,TEXT:25,OID:26,TID:27,XID:28,CID:29,JSON:114,XML:142,PG_NODE_TREE:194,SMGR:210,PATH:602,POLYGON:604,CIDR:650,FLOAT4:700,FLOAT8:701,ABSTIME:702,RELTIME:703,TINTERVAL:704,CIRCLE:718,MACADDR8:774,MONEY:790,MACADDR:829,INET:869,ACLITEM:1033,BPCHAR:1042,VARCHAR:1043,DATE:1082,TIME:1083,TIMESTAMP:1114,TIMESTAMPTZ:1184,INTERVAL:1186,TIMETZ:1266,BIT:1560,VARBIT:1562,NUMERIC:1700,REFCURSOR:1790,REGPROCEDURE:2202,REGOPER:2203,REGOPERATOR:2204,REGCLASS:2205,REGTYPE:2206,UUID:2950,TXID_SNAPSHOT:2970,PG_LSN:3220,PG_NDISTINCT:3361,PG_DEPENDENCIES:3402,TSVECTOR:3614,TSQUERY:3615,GTSVECTOR:3642,REGCONFIG:3734,REGDICTIONARY:3769,JSONB:3802,REGNAMESPACE:4089,REGROLE:4096}});var Re=g(be=>{var Pi=ir(),Ui=pr(),Bi=ft(),Fi=fr();be.getTypeParser=$i;be.setTypeParser=qi;be.arrayParser=Bi;be.builtins=Fi;var Te={text:{},binary:{}};function mr(s){return String(s)}function $i(s,e){return e=e||"text",Te[e]&&Te[e][s]||mr}function qi(s,e,t){typeof e=="function"&&(t=e,e="text"),Te[e][s]=t}Pi.init(function(s,e){Te.text[s]=e});Ui.init(function(s,e){Te.binary[s]=e})});var Ae=g((su,bt)=>{"use strict";bt.exports={host:"localhost",user:process.platform==="win32"?process.env.USERNAME:process.env.USER,database:void 0,password:null,connectionString:void 0,port:5432,rows:0,binary:!1,max:10,idleTimeoutMillis:3e4,client_encoding:"",ssl:!1,application_name:void 0,fallback_application_name:void 0,options:void 0,parseInputDatesAsUTC:!1,statement_timeout:!1,lock_timeout:!1,idle_in_transaction_session_timeout:!1,query_timeout:!1,connect_timeout:0,keepalives:1,keepalives_idle:0};var oe=Re(),ji=oe.getTypeParser(20,"text"),Hi=oe.getTypeParser(1016,"text");bt.exports.__defineSetter__("parseInt8",function(s){oe.setTypeParser(20,"text",s?oe.getTypeParser(23,"text"):ji),oe.setTypeParser(1016,"text",s?oe.getTypeParser(1007,"text"):Hi)})});var ae=g((ru,gr)=>{"use strict";var Qi=Ae(),_r=require("util"),{isDate:Gi}=_r.types||_r;function Xi(s){return'"'+s.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'}function Er(s){let e="{";for(let t=0;t<s.length;t++)if(t>0&&(e=e+","),s[t]===null||typeof s[t]>"u")e=e+"NULL";else if(Array.isArray(s[t]))e=e+Er(s[t]);else if(ArrayBuffer.isView(s[t])){let r=s[t];if(!(r instanceof Buffer)){let n=Buffer.from(r.buffer,r.byteOffset,r.byteLength);n.length===r.byteLength?r=n:r=n.slice(r.byteOffset,r.byteOffset+r.byteLength)}e+="\\\\x"+r.toString("hex")}else e+=Xi(Fe(s[t]));return e=e+"}",e}var Fe=function(s,e){if(s==null)return null;if(typeof s=="object"){if(s instanceof Buffer)return s;if(ArrayBuffer.isView(s)){let t=Buffer.from(s.buffer,s.byteOffset,s.byteLength);return t.length===s.byteLength?t:t.slice(s.byteOffset,s.byteOffset+s.byteLength)}return Gi(s)?Qi.parseInputDatesAsUTC?Yi(s):Vi(s):Array.isArray(s)?Er(s):Wi(s,e)}return s.toString()};function Wi(s,e){if(s&&typeof s.toPostgres=="function"){if(e=e||[],e.indexOf(s)!==-1)throw new Error('circular reference detected while preparing "'+s+'" for query');return e.push(s),Fe(s.toPostgres(Fe),e)}return JSON.stringify(s)}function Vi(s){let e=-s.getTimezoneOffset(),t=s.getFullYear(),r=t<1;r&&(t=Math.abs(t)+1);let n=String(t).padStart(4,"0")+"-"+String(s.getMonth()+1).padStart(2,"0")+"-"+String(s.getDate()).padStart(2,"0")+"T"+String(s.getHours()).padStart(2,"0")+":"+String(s.getMinutes()).padStart(2,"0")+":"+String(s.getSeconds()).padStart(2,"0")+"."+String(s.getMilliseconds()).padStart(3,"0");return e<0?(n+="-",e*=-1):n+="+",n+=String(Math.floor(e/60)).padStart(2,"0")+":"+String(e%60).padStart(2,"0"),r&&(n+=" BC"),n}function Yi(s){let e=s.getUTCFullYear(),t=e<1;t&&(e=Math.abs(e)+1);let r=String(e).padStart(4,"0")+"-"+String(s.getUTCMonth()+1).padStart(2,"0")+"-"+String(s.getUTCDate()).padStart(2,"0")+"T"+String(s.getUTCHours()).padStart(2,"0")+":"+String(s.getUTCMinutes()).padStart(2,"0")+":"+String(s.getUTCSeconds()).padStart(2,"0")+"."+String(s.getUTCMilliseconds()).padStart(3,"0");return r+="+00:00",t&&(r+=" BC"),r}function Ki(s,e,t){return s=typeof s=="string"?{text:s}:s,e&&(typeof e=="function"?s.callback=e:s.values=e),t&&(s.callback=t),s}var Ji=function(s){return'"'+s.replace(/"/g,'""')+'"'},zi=function(s){let e=!1,t="'";if(s==null||typeof s!="string")return"''";for(let r=0;r<s.length;r++){let n=s[r];n==="'"?t+=n+n:n==="\\"?(t+=n+n,e=!0):t+=n}return t+="'",e===!0&&(t=" E"+t),t};gr.exports={prepareValue:function(e){return Fe(e)},normalizeQueryConfig:Ki,escapeIdentifier:Ji,escapeLiteral:zi}});var yr=g((nu,Sr)=>{"use strict";var ce=require("crypto");function Rt(s){return ce.createHash("md5").update(s,"utf-8").digest("hex")}function Zi(s,e,t){let r=Rt(e+s);return"md5"+Rt(Buffer.concat([Buffer.from(r),t]))}function eo(s){return ce.createHash("sha256").update(s).digest()}function to(s,e){return s=s.replace(/(\D)-/,"$1"),ce.createHash(s).update(e).digest()}function so(s,e){return ce.createHmac("sha256",s).update(e).digest()}async function ro(s,e,t){return ce.pbkdf2Sync(s,e,t,32,"sha256")}Sr.exports={postgresMd5PasswordHash:Zi,randomBytes:ce.randomBytes,deriveKey:ro,sha256:eo,hashByName:to,hmacSha256:so,md5:Rt}});var Ar=g((iu,Rr)=>{var Tr=require("crypto");Rr.exports={postgresMd5PasswordHash:io,randomBytes:no,deriveKey:uo,sha256:oo,hashByName:ao,hmacSha256:co,md5:At};var br=Tr.webcrypto||globalThis.crypto,ee=br.subtle,vt=new TextEncoder;function no(s){return br.getRandomValues(Buffer.alloc(s))}async function At(s){try{return Tr.createHash("md5").update(s,"utf-8").digest("hex")}catch{let t=typeof s=="string"?vt.encode(s):s,r=await ee.digest("MD5",t);return Array.from(new Uint8Array(r)).map(n=>n.toString(16).padStart(2,"0")).join("")}}async function io(s,e,t){let r=await At(e+s);return"md5"+await At(Buffer.concat([Buffer.from(r),t]))}async function oo(s){return await ee.digest("SHA-256",s)}async function ao(s,e){return await ee.digest(s,e)}async function co(s,e){let t=await ee.importKey("raw",s,{name:"HMAC",hash:"SHA-256"},!1,["sign"]);return await ee.sign("HMAC",t,vt.encode(e))}async function uo(s,e,t){let r=await ee.importKey("raw",vt.encode(s),"PBKDF2",!1,["deriveBits"]),n={name:"PBKDF2",hash:"SHA-256",salt:e,iterations:t};return await ee.deriveBits(n,r,256,["deriveBits"])}});var Ot=g((ou,Ct)=>{"use strict";var lo=parseInt(process.versions&&process.versions.node&&process.versions.node.split(".")[0])<15;lo?Ct.exports=yr():Ct.exports=Ar()});var Or=g((au,Cr)=>{function te(s,e){return new Error("SASL channel binding: "+s+" when parsing public certificate "+e.toString("base64"))}function It(s,e){let t=s[e++];if(t<128)return{length:t,index:e};let r=t&127;if(r>4)throw te("bad length",s);t=0;for(let n=0;n<r;n++)t=t<<8|s[e++];return{length:t,index:e}}function vr(s,e){if(s[e++]!==6)throw te("non-OID data",s);let{length:t,index:r}=It(s,e);e=r;let n=e+t,i=s[e++],o=(i/40>>0)+"."+i%40;for(;e<n;){let a=0;for(;e<n;){let c=s[e++];if(a=a<<7|c&127,c<128)break}o+="."+a}return{oid:o,index:e}}function ve(s,e){if(s[e++]!==48)throw te("non-sequence data",s);return It(s,e)}function po(s,e){e===void 0&&(e=0),e=ve(s,e).index;let{length:t,index:r}=ve(s,e);e=r+t,e=ve(s,e).index;let{oid:n,index:i}=vr(s,e);switch(n){case"1.2.840.113549.1.1.4":return"MD5";case"1.2.840.113549.1.1.5":return"SHA-1";case"1.2.840.113549.1.1.11":return"SHA-256";case"1.2.840.113549.1.1.12":return"SHA-384";case"1.2.840.113549.1.1.13":return"SHA-512";case"1.2.840.113549.1.1.14":return"SHA-224";case"1.2.840.113549.1.1.15":return"SHA512-224";case"1.2.840.113549.1.1.16":return"SHA512-256";case"1.2.840.10045.4.1":return"SHA-1";case"1.2.840.10045.4.3.1":return"SHA-224";case"1.2.840.10045.4.3.2":return"SHA-256";case"1.2.840.10045.4.3.3":return"SHA-384";case"1.2.840.10045.4.3.4":return"SHA-512";case"1.2.840.113549.1.1.10":{if(e=i,e=ve(s,e).index,s[e++]!==160)throw te("non-tag data",s);e=It(s,e).index,e=ve(s,e).index;let{oid:o}=vr(s,e);switch(o){case"1.2.840.113549.2.5":return"MD5";case"1.3.14.3.2.26":return"SHA-1";case"2.16.840.1.101.3.4.2.1":return"SHA-256";case"2.16.840.1.101.3.4.2.2":return"SHA-384";case"2.16.840.1.101.3.4.2.3":return"SHA-512"}throw te("unknown hash OID "+o,s)}case"1.3.101.110":case"1.3.101.112":return"SHA-512";case"1.3.101.111":case"1.3.101.113":throw te("Ed448 certificate channel binding is not currently supported by Postgres")}throw te("unknown OID "+n,s)}Cr.exports={signatureAlgorithmHashFromCertificate:po}});var Nr=g((cu,Lr)=>{"use strict";var V=Ot(),{signatureAlgorithmHashFromCertificate:ho}=Or();function fo(s,e){let t=["SCRAM-SHA-256"];e&&t.unshift("SCRAM-SHA-256-PLUS");let r=t.find(o=>s.includes(o));if(!r)throw new Error("SASL: Only mechanism(s) "+t.join(" and ")+" are supported");if(r==="SCRAM-SHA-256-PLUS"&&typeof e.getPeerCertificate!="function")throw new Error("SASL: Mechanism SCRAM-SHA-256-PLUS requires a certificate");let n=V.randomBytes(18).toString("base64");return{mechanism:r,clientNonce:n,response:(r==="SCRAM-SHA-256-PLUS"?"p=tls-server-end-point":e?"y":"n")+",,n=*,r="+n,message:"SASLInitialResponse"}}async function mo(s,e,t,r){if(s.message!=="SASLInitialResponse")throw new Error("SASL: Last message was not SASLInitialResponse");if(typeof e!="string")throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: client password must be a string");if(e==="")throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: client password must be a non-empty string");if(typeof t!="string")throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: serverData must be a string");let n=go(t);if(n.nonce.startsWith(s.clientNonce)){if(n.nonce.length===s.clientNonce.length)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce is too short")}else throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce does not start with client nonce");let i="n=*,r="+s.clientNonce,o="r="+n.nonce+",s="+n.salt+",i="+n.iteration,a=r?"eSws":"biws";if(s.mechanism==="SCRAM-SHA-256-PLUS"){let L=r.getPeerCertificate().raw,P=ho(L);(P==="MD5"||P==="SHA-1")&&(P="SHA-256");let we=await V.hashByName(P,L);a=Buffer.concat([Buffer.from("p=tls-server-end-point,,"),Buffer.from(we)]).toString("base64")}let c="c="+a+",r="+n.nonce,l=i+","+o+","+c,p=Buffer.from(n.salt,"base64"),f=await V.deriveKey(e,p,n.iteration),_=await V.hmacSha256(f,"Client Key"),u=await V.sha256(_),y=await V.hmacSha256(u,l),S=yo(Buffer.from(_),Buffer.from(y)).toString("base64"),h=await V.hmacSha256(f,"Server Key"),C=await V.hmacSha256(h,l);s.message="SASLResponse",s.serverSignature=Buffer.from(C).toString("base64"),s.response=c+",p="+S}function _o(s,e){if(s.message!=="SASLResponse")throw new Error("SASL: Last message was not SASLResponse");if(typeof e!="string")throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: serverData must be a string");let{serverSignature:t}=So(e);if(t!==s.serverSignature)throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature does not match")}function Eo(s){if(typeof s!="string")throw new TypeError("SASL: text must be a string");return s.split("").map((e,t)=>s.charCodeAt(t)).every(e=>e>=33&&e<=43||e>=45&&e<=126)}function Ir(s){return/^(?:[a-zA-Z0-9+/]{4})*(?:[a-zA-Z0-9+/]{2}==|[a-zA-Z0-9+/]{3}=)?$/.test(s)}function wr(s){if(typeof s!="string")throw new TypeError("SASL: attribute pairs text must be a string");return new Map(s.split(",").map(e=>{if(!/^.=/.test(e))throw new Error("SASL: Invalid attribute pair entry");let t=e[0],r=e.substring(2);return[t,r]}))}function go(s){let e=wr(s),t=e.get("r");if(t){if(!Eo(t))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce must only contain printable characters")}else throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce missing");let r=e.get("s");if(r){if(!Ir(r))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt must be base64")}else throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt missing");let n=e.get("i");if(n){if(!/^[1-9][0-9]*$/.test(n))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: invalid iteration count")}else throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: iteration missing");let i=parseInt(n,10);return{nonce:t,salt:r,iteration:i}}function So(s){let t=wr(s).get("v");if(t){if(!Ir(t))throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature must be base64")}else throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature is missing");return{serverSignature:t}}function yo(s,e){if(!Buffer.isBuffer(s))throw new TypeError("first argument must be a Buffer");if(!Buffer.isBuffer(e))throw new TypeError("second argument must be a Buffer");if(s.length!==e.length)throw new Error("Buffer lengths must match");if(s.length===0)throw new Error("Buffers cannot be empty");return Buffer.from(s.map((t,r)=>s[r]^e[r]))}Lr.exports={startSession:fo,continueSession:mo,finalizeSession:_o}});var qe=g((uu,Mr)=>{"use strict";var To=Re();function $e(s){this._types=s||To,this.text={},this.binary={}}$e.prototype.getOverrides=function(s){switch(s){case"text":return this.text;case"binary":return this.binary;default:return{}}};$e.prototype.setTypeParser=function(s,e,t){typeof e=="function"&&(t=e,e="text"),this.getOverrides(e)[s]=t};$e.prototype.getTypeParser=function(s,e){return e=e||"text",this.getOverrides(e)[s]||this._types.getTypeParser(s,e)};Mr.exports=$e});var xr=g((lu,kr)=>{"use strict";function ue(s,e={}){if(s.charAt(0)==="/"){let c=s.split(" ");return{host:c[0],database:c[1]}}let t={},r,n=!1;/ |%[^a-f0-9]|%[a-f0-9][^a-f0-9]/i.test(s)&&(s=encodeURI(s).replace(/%25(\d\d)/g,"%$1"));try{try{r=new URL(s,"postgres://base")}catch{r=new URL(s.replace("@/","@___DUMMY___/"),"postgres://base"),n=!0}}catch(c){c.input&&(c.input="*****REDACTED*****")}for(let c of r.searchParams.entries())t[c[0]]=c[1];if(t.user=t.user||decodeURIComponent(r.username),t.password=t.password||decodeURIComponent(r.password),r.protocol=="socket:")return t.host=decodeURI(r.pathname),t.database=r.searchParams.get("db"),t.client_encoding=r.searchParams.get("encoding"),t;let i=n?"":r.hostname;t.host?i&&/^%2f/i.test(i)&&(r.pathname=i+r.pathname):t.host=decodeURIComponent(i),t.port||(t.port=r.port);let o=r.pathname.slice(1)||null;t.database=o?decodeURI(o):null,(t.ssl==="true"||t.ssl==="1")&&(t.ssl=!0),t.ssl==="0"&&(t.ssl=!1),(t.sslcert||t.sslkey||t.sslrootcert||t.sslmode)&&(t.ssl={});let a=t.sslcert||t.sslkey||t.sslrootcert?require("fs"):null;if(t.sslcert&&(t.ssl.cert=a.readFileSync(t.sslcert).toString()),t.sslkey&&(t.ssl.key=a.readFileSync(t.sslkey).toString()),t.sslrootcert&&(t.ssl.ca=a.readFileSync(t.sslrootcert).toString()),e.useLibpqCompat&&t.uselibpqcompat)throw new Error("Both useLibpqCompat and uselibpqcompat are set. Please use only one of them.");if(t.uselibpqcompat==="true"||e.useLibpqCompat)switch(t.sslmode){case"disable":{t.ssl=!1;break}case"prefer":{t.ssl.rejectUnauthorized=!1;break}case"require":{t.sslrootcert?t.ssl.checkServerIdentity=function(){}:t.ssl.rejectUnauthorized=!1;break}case"verify-ca":{if(!t.ssl.ca)throw new Error("SECURITY WARNING: Using sslmode=verify-ca requires specifying a CA with sslrootcert. If a public CA is used, verify-ca allows connections to a server that somebody else may have registered with the CA, making you vulnerable to Man-in-the-Middle attacks. Either specify a custom CA certificate with sslrootcert parameter or use sslmode=verify-full for proper security.");t.ssl.checkServerIdentity=function(){};break}case"verify-full":break}else switch(t.sslmode){case"disable":{t.ssl=!1;break}case"prefer":case"require":case"verify-ca":case"verify-full":break;case"no-verify":{t.ssl.rejectUnauthorized=!1;break}}return t}function bo(s){return Object.entries(s).reduce((t,[r,n])=>(n!=null&&(t[r]=n),t),{})}function Dr(s){return Object.entries(s).reduce((t,[r,n])=>{if(r==="ssl"){let i=n;typeof i=="boolean"&&(t[r]=i),typeof i=="object"&&(t[r]=bo(i))}else if(n!=null)if(r==="port"){if(n!==""){let i=parseInt(n,10);if(isNaN(i))throw new Error(`Invalid ${r}: ${n}`);t[r]=i}}else t[r]=n;return t},{})}function Ro(s){return Dr(ue(s))}kr.exports=ue;ue.parse=ue;ue.toClientConfig=Dr;ue.parseIntoClientConfig=Ro});var Lt=g((du,Br)=>{"use strict";var Ao=require("dns"),Ur=Ae(),Pr=xr().parse,D=function(s,e,t){return t===void 0?t=process.env["PG"+s.toUpperCase()]:t===!1||(t=process.env[t]),e[s]||t||Ur[s]},vo=function(){switch(process.env.PGSSLMODE){case"disable":return!1;case"prefer":case"require":case"verify-ca":case"verify-full":return!0;case"no-verify":return{rejectUnauthorized:!1}}return Ur.ssl},le=function(s){return"'"+(""+s).replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"},B=function(s,e,t){let r=e[t];r!=null&&s.push(t+"="+le(r))},wt=class{constructor(e){e=typeof e=="string"?Pr(e):e||{},e.connectionString&&(e=Object.assign({},e,Pr(e.connectionString))),this.user=D("user",e),this.database=D("database",e),this.database===void 0&&(this.database=this.user),this.port=parseInt(D("port",e),10),this.host=D("host",e),Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:D("password",e)}),this.binary=D("binary",e),this.options=D("options",e),this.ssl=typeof e.ssl>"u"?vo():e.ssl,typeof this.ssl=="string"&&this.ssl==="true"&&(this.ssl=!0),this.ssl==="no-verify"&&(this.ssl={rejectUnauthorized:!1}),this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this.client_encoding=D("client_encoding",e),this.replication=D("replication",e),this.isDomainSocket=!(this.host||"").indexOf("/"),this.application_name=D("application_name",e,"PGAPPNAME"),this.fallback_application_name=D("fallback_application_name",e,!1),this.statement_timeout=D("statement_timeout",e,!1),this.lock_timeout=D("lock_timeout",e,!1),this.idle_in_transaction_session_timeout=D("idle_in_transaction_session_timeout",e,!1),this.query_timeout=D("query_timeout",e,!1),e.connectionTimeoutMillis===void 0?this.connect_timeout=process.env.PGCONNECT_TIMEOUT||0:this.connect_timeout=Math.floor(e.connectionTimeoutMillis/1e3),e.keepAlive===!1?this.keepalives=0:e.keepAlive===!0&&(this.keepalives=1),typeof e.keepAliveInitialDelayMillis=="number"&&(this.keepalives_idle=Math.floor(e.keepAliveInitialDelayMillis/1e3))}getLibpqConnectionString(e){let t=[];B(t,this,"user"),B(t,this,"password"),B(t,this,"port"),B(t,this,"application_name"),B(t,this,"fallback_application_name"),B(t,this,"connect_timeout"),B(t,this,"options");let r=typeof this.ssl=="object"?this.ssl:this.ssl?{sslmode:this.ssl}:{};if(B(t,r,"sslmode"),B(t,r,"sslca"),B(t,r,"sslkey"),B(t,r,"sslcert"),B(t,r,"sslrootcert"),this.database&&t.push("dbname="+le(this.database)),this.replication&&t.push("replication="+le(this.replication)),this.host&&t.push("host="+le(this.host)),this.isDomainSocket)return e(null,t.join(" "));this.client_encoding&&t.push("client_encoding="+le(this.client_encoding)),Ao.lookup(this.host,function(n,i){return n?e(n,null):(t.push("hostaddr="+le(i)),e(null,t.join(" ")))})}};Br.exports=wt});var Mt=g((pu,$r)=>{"use strict";var Co=Re(),Fr=/^([A-Za-z]+)(?: (\d+))?(?: (\d+))?/,Nt=class{constructor(e,t){this.command=null,this.rowCount=null,this.oid=null,this.rows=[],this.fields=[],this._parsers=void 0,this._types=t,this.RowCtor=null,this.rowAsArray=e==="array",this.rowAsArray&&(this.parseRow=this._parseRowAsArray),this._prebuiltEmptyResultObject=null}addCommandComplete(e){let t;e.text?t=Fr.exec(e.text):t=Fr.exec(e.command),t&&(this.command=t[1],t[3]?(this.oid=parseInt(t[2],10),this.rowCount=parseInt(t[3],10)):t[2]&&(this.rowCount=parseInt(t[2],10)))}_parseRowAsArray(e){let t=new Array(e.length);for(let r=0,n=e.length;r<n;r++){let i=e[r];i!==null?t[r]=this._parsers[r](i):t[r]=null}return t}parseRow(e){let t={...this._prebuiltEmptyResultObject};for(let r=0,n=e.length;r<n;r++){let i=e[r],o=this.fields[r].name;if(i!==null){let a=this.fields[r].format==="binary"?Buffer.from(i):i;t[o]=this._parsers[r](a)}else t[o]=null}return t}addRow(e){this.rows.push(e)}addFields(e){this.fields=e,this.fields.length&&(this._parsers=new Array(e.length));let t={};for(let r=0;r<e.length;r++){let n=e[r];t[n.name]=null,this._types?this._parsers[r]=this._types.getTypeParser(n.dataTypeID,n.format||"text"):this._parsers[r]=Co.getTypeParser(n.dataTypeID,n.format||"text")}this._prebuiltEmptyResultObject={...t}}};$r.exports=Nt});var Qr=g((hu,Hr)=>{"use strict";var{EventEmitter:Oo}=require("events"),qr=Mt(),jr=ae(),Dt=class extends Oo{constructor(e,t,r){super(),e=jr.normalizeQueryConfig(e,t,r),this.text=e.text,this.values=e.values,this.rows=e.rows,this.types=e.types,this.name=e.name,this.queryMode=e.queryMode,this.binary=e.binary,this.portal=e.portal||"",this.callback=e.callback,this._rowMode=e.rowMode,process.domain&&e.callback&&(this.callback=process.domain.bind(e.callback)),this._result=new qr(this._rowMode,this.types),this._results=this._result,this._canceledDueToError=!1}requiresPreparation(){return this.queryMode==="extended"||this.name||this.rows?!0:!this.text||!this.values?!1:this.values.length>0}_checkForMultirow(){this._result.command&&(Array.isArray(this._results)||(this._results=[this._result]),this._result=new qr(this._rowMode,this._result._types),this._results.push(this._result))}handleRowDescription(e){this._checkForMultirow(),this._result.addFields(e.fields),this._accumulateRows=this.callback||!this.listeners("row").length}handleDataRow(e){let t;if(!this._canceledDueToError){try{t=this._result.parseRow(e.fields)}catch(r){this._canceledDueToError=r;return}this.emit("row",t,this._result),this._accumulateRows&&this._result.addRow(t)}}handleCommandComplete(e,t){this._checkForMultirow(),this._result.addCommandComplete(e),this.rows&&t.sync()}handleEmptyQuery(e){this.rows&&e.sync()}handleError(e,t){if(this._canceledDueToError&&(e=this._canceledDueToError,this._canceledDueToError=!1),this.callback)return this.callback(e);this.emit("error",e)}handleReadyForQuery(e){if(this._canceledDueToError)return this.handleError(this._canceledDueToError,e);if(this.callback)try{this.callback(null,this._results)}catch(t){process.nextTick(()=>{throw t})}this.emit("end",this._results)}submit(e){if(typeof this.text!="string"&&typeof this.name!="string")return new Error("A query must have either text or a name. Supplying neither is unsupported.");let t=e.parsedStatements[this.name];if(this.text&&t&&this.text!==t)return new Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`);if(this.values&&!Array.isArray(this.values))return new Error("Query values must be an array");if(this.requiresPreparation()){e.stream.cork&&e.stream.cork();try{this.prepare(e)}finally{e.stream.uncork&&e.stream.uncork()}}else e.query(this.text);return null}hasBeenParsed(e){return this.name&&e.parsedStatements[this.name]}handlePortalSuspended(e){this._getRows(e,this.rows)}_getRows(e,t){e.execute({portal:this.portal,rows:t}),t?e.flush():e.sync()}prepare(e){this.hasBeenParsed(e)||e.parse({text:this.text,name:this.name,types:this.types});try{e.bind({portal:this.portal,statement:this.name,values:this.values,binary:this.binary,valueMapper:jr.prepareValue})}catch(t){this.handleError(t,e);return}e.describe({type:"P",name:this.portal||""}),this._getRows(e,this.rows)}handleCopyInResponse(e){e.sendCopyFail("No source stream defined")}handleCopyData(e,t){}};Hr.exports=Dt});var Vt=g(m=>{"use strict";Object.defineProperty(m,"__esModule",{value:!0});m.NoticeMessage=m.DataRowMessage=m.CommandCompleteMessage=m.ReadyForQueryMessage=m.NotificationResponseMessage=m.BackendKeyDataMessage=m.AuthenticationMD5Password=m.ParameterStatusMessage=m.ParameterDescriptionMessage=m.RowDescriptionMessage=m.Field=m.CopyResponse=m.CopyDataMessage=m.DatabaseError=m.copyDone=m.emptyQuery=m.replicationStart=m.portalSuspended=m.noData=m.closeComplete=m.bindComplete=m.parseComplete=void 0;m.parseComplete={name:"parseComplete",length:5};m.bindComplete={name:"bindComplete",length:5};m.closeComplete={name:"closeComplete",length:5};m.noData={name:"noData",length:5};m.portalSuspended={name:"portalSuspended",length:5};m.replicationStart={name:"replicationStart",length:4};m.emptyQuery={name:"emptyQuery",length:4};m.copyDone={name:"copyDone",length:4};var kt=class extends Error{constructor(e,t,r){super(e),this.length=t,this.name=r}};m.DatabaseError=kt;var xt=class{constructor(e,t){this.length=e,this.chunk=t,this.name="copyData"}};m.CopyDataMessage=xt;var Pt=class{constructor(e,t,r,n){this.length=e,this.name=t,this.binary=r,this.columnTypes=new Array(n)}};m.CopyResponse=Pt;var Ut=class{constructor(e,t,r,n,i,o,a){this.name=e,this.tableID=t,this.columnID=r,this.dataTypeID=n,this.dataTypeSize=i,this.dataTypeModifier=o,this.format=a}};m.Field=Ut;var Bt=class{constructor(e,t){this.length=e,this.fieldCount=t,this.name="rowDescription",this.fields=new Array(this.fieldCount)}};m.RowDescriptionMessage=Bt;var Ft=class{constructor(e,t){this.length=e,this.parameterCount=t,this.name="parameterDescription",this.dataTypeIDs=new Array(this.parameterCount)}};m.ParameterDescriptionMessage=Ft;var $t=class{constructor(e,t,r){this.length=e,this.parameterName=t,this.parameterValue=r,this.name="parameterStatus"}};m.ParameterStatusMessage=$t;var qt=class{constructor(e,t){this.length=e,this.salt=t,this.name="authenticationMD5Password"}};m.AuthenticationMD5Password=qt;var jt=class{constructor(e,t,r){this.length=e,this.processID=t,this.secretKey=r,this.name="backendKeyData"}};m.BackendKeyDataMessage=jt;var Ht=class{constructor(e,t,r,n){this.length=e,this.processId=t,this.channel=r,this.payload=n,this.name="notification"}};m.NotificationResponseMessage=Ht;var Qt=class{constructor(e,t){this.length=e,this.status=t,this.name="readyForQuery"}};m.ReadyForQueryMessage=Qt;var Gt=class{constructor(e,t){this.length=e,this.text=t,this.name="commandComplete"}};m.CommandCompleteMessage=Gt;var Xt=class{constructor(e,t){this.length=e,this.fields=t,this.name="dataRow",this.fieldCount=t.length}};m.DataRowMessage=Xt;var Wt=class{constructor(e,t){this.length=e,this.message=t,this.name="notice"}};m.NoticeMessage=Wt});var Gr=g(je=>{"use strict";Object.defineProperty(je,"__esModule",{value:!0});je.Writer=void 0;var Yt=class{constructor(e=256){this.size=e,this.offset=5,this.headerPosition=0,this.buffer=Buffer.allocUnsafe(e)}ensure(e){if(this.buffer.length-this.offset<e){let r=this.buffer,n=r.length+(r.length>>1)+e;this.buffer=Buffer.allocUnsafe(n),r.copy(this.buffer)}}addInt32(e){return this.ensure(4),this.buffer[this.offset++]=e>>>24&255,this.buffer[this.offset++]=e>>>16&255,this.buffer[this.offset++]=e>>>8&255,this.buffer[this.offset++]=e>>>0&255,this}addInt16(e){return this.ensure(2),this.buffer[this.offset++]=e>>>8&255,this.buffer[this.offset++]=e>>>0&255,this}addCString(e){if(!e)this.ensure(1);else{let t=Buffer.byteLength(e);this.ensure(t+1),this.buffer.write(e,this.offset,"utf-8"),this.offset+=t}return this.buffer[this.offset++]=0,this}addString(e=""){let t=Buffer.byteLength(e);return this.ensure(t),this.buffer.write(e,this.offset),this.offset+=t,this}add(e){return this.ensure(e.length),e.copy(this.buffer,this.offset),this.offset+=e.length,this}join(e){if(e){this.buffer[this.headerPosition]=e;let t=this.offset-(this.headerPosition+1);this.buffer.writeInt32BE(t,this.headerPosition+1)}return this.buffer.slice(e?0:5,this.offset)}flush(e){let t=this.join(e);return this.offset=5,this.headerPosition=0,this.buffer=Buffer.allocUnsafe(this.size),t}};je.Writer=Yt});var Wr=g(Qe=>{"use strict";Object.defineProperty(Qe,"__esModule",{value:!0});Qe.serialize=void 0;var Kt=Gr(),b=new Kt.Writer,Io=s=>{b.addInt16(3).addInt16(0);for(let r of Object.keys(s))b.addCString(r).addCString(s[r]);b.addCString("client_encoding").addCString("UTF8");let e=b.addCString("").flush(),t=e.length+4;return new Kt.Writer().addInt32(t).add(e).flush()},wo=()=>{let s=Buffer.allocUnsafe(8);return s.writeInt32BE(8,0),s.writeInt32BE(80877103,4),s},Lo=s=>b.addCString(s).flush(112),No=function(s,e){return b.addCString(s).addInt32(Buffer.byteLength(e)).addString(e),b.flush(112)},Mo=function(s){return b.addString(s).flush(112)},Do=s=>b.addCString(s).flush(81),Xr=[],ko=s=>{let e=s.name||"";e.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",e,e.length),console.error("This can cause conflicts and silent errors executing queries"));let t=s.types||Xr,r=t.length,n=b.addCString(e).addCString(s.text).addInt16(r);for(let i=0;i<r;i++)n.addInt32(t[i]);return b.flush(80)},de=new Kt.Writer,xo=function(s,e){for(let t=0;t<s.length;t++){let r=e?e(s[t],t):s[t];r==null?(b.addInt16(0),de.addInt32(-1)):r instanceof Buffer?(b.addInt16(1),de.addInt32(r.length),de.add(r)):(b.addInt16(0),de.addInt32(Buffer.byteLength(r)),de.addString(r))}},Po=(s={})=>{let e=s.portal||"",t=s.statement||"",r=s.binary||!1,n=s.values||Xr,i=n.length;return b.addCString(e).addCString(t),b.addInt16(i),xo(n,s.valueMapper),b.addInt16(i),b.add(de.flush()),b.addInt16(1),b.addInt16(r?1:0),b.flush(66)},Uo=Buffer.from([69,0,0,0,9,0,0,0,0,0]),Bo=s=>{if(!s||!s.portal&&!s.rows)return Uo;let e=s.portal||"",t=s.rows||0,r=Buffer.byteLength(e),n=4+r+1+4,i=Buffer.allocUnsafe(1+n);return i[0]=69,i.writeInt32BE(n,1),i.write(e,5,"utf-8"),i[r+5]=0,i.writeUInt32BE(t,i.length-4),i},Fo=(s,e)=>{let t=Buffer.allocUnsafe(16);return t.writeInt32BE(16,0),t.writeInt16BE(1234,4),t.writeInt16BE(5678,6),t.writeInt32BE(s,8),t.writeInt32BE(e,12),t},Jt=(s,e)=>{let r=4+Buffer.byteLength(e)+1,n=Buffer.allocUnsafe(1+r);return n[0]=s,n.writeInt32BE(r,1),n.write(e,5,"utf-8"),n[r]=0,n},$o=b.addCString("P").flush(68),qo=b.addCString("S").flush(68),jo=s=>s.name?Jt(68,`${s.type}${s.name||""}`):s.type==="P"?$o:qo,Ho=s=>{let e=`${s.type}${s.name||""}`;return Jt(67,e)},Qo=s=>b.add(s).flush(100),Go=s=>Jt(102,s),He=s=>Buffer.from([s,0,0,0,4]),Xo=He(72),Wo=He(83),Vo=He(88),Yo=He(99),Ko={startup:Io,password:Lo,requestSsl:wo,sendSASLInitialResponseMessage:No,sendSCRAMClientFinalMessage:Mo,query:Do,parse:ko,bind:Po,execute:Bo,describe:jo,close:Ho,flush:()=>Xo,sync:()=>Wo,end:()=>Vo,copyData:Qo,copyDone:()=>Yo,copyFail:Go,cancel:Fo};Qe.serialize=Ko});var Vr=g(Ge=>{"use strict";Object.defineProperty(Ge,"__esModule",{value:!0});Ge.BufferReader=void 0;var Jo=Buffer.allocUnsafe(0),zt=class{constructor(e=0){this.offset=e,this.buffer=Jo,this.encoding="utf-8"}setBuffer(e,t){this.offset=e,this.buffer=t}int16(){let e=this.buffer.readInt16BE(this.offset);return this.offset+=2,e}byte(){let e=this.buffer[this.offset];return this.offset++,e}int32(){let e=this.buffer.readInt32BE(this.offset);return this.offset+=4,e}uint32(){let e=this.buffer.readUInt32BE(this.offset);return this.offset+=4,e}string(e){let t=this.buffer.toString(this.encoding,this.offset,this.offset+e);return this.offset+=e,t}cstring(){let e=this.offset,t=e;for(;this.buffer[t++]!==0;);return this.offset=t,this.buffer.toString(this.encoding,e,t-1)}bytes(e){let t=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}};Ge.BufferReader=zt});var Jr=g(Xe=>{"use strict";Object.defineProperty(Xe,"__esModule",{value:!0});Xe.Parser=void 0;var v=Vt(),zo=Vr(),Zt=1,Zo=4,Yr=Zt+Zo,Kr=Buffer.allocUnsafe(0),es=class{constructor(e){if(this.buffer=Kr,this.bufferLength=0,this.bufferOffset=0,this.reader=new zo.BufferReader,e?.mode==="binary")throw new Error("Binary mode not supported yet");this.mode=e?.mode||"text"}parse(e,t){this.mergeBuffer(e);let r=this.bufferOffset+this.bufferLength,n=this.bufferOffset;for(;n+Yr<=r;){let i=this.buffer[n],o=this.buffer.readUInt32BE(n+Zt),a=Zt+o;if(a+n<=r){let c=this.handlePacket(n+Yr,i,o,this.buffer);t(c),n+=a}else break}n===r?(this.buffer=Kr,this.bufferLength=0,this.bufferOffset=0):(this.bufferLength=r-n,this.bufferOffset=n)}mergeBuffer(e){if(this.bufferLength>0){let t=this.bufferLength+e.byteLength;if(t+this.bufferOffset>this.buffer.byteLength){let n;if(t<=this.buffer.byteLength&&this.bufferOffset>=this.bufferLength)n=this.buffer;else{let i=this.buffer.byteLength*2;for(;t>=i;)i*=2;n=Buffer.allocUnsafe(i)}this.buffer.copy(n,0,this.bufferOffset,this.bufferOffset+this.bufferLength),this.buffer=n,this.bufferOffset=0}e.copy(this.buffer,this.bufferOffset+this.bufferLength),this.bufferLength=t}else this.buffer=e,this.bufferOffset=0,this.bufferLength=e.byteLength}handlePacket(e,t,r,n){switch(t){case 50:return v.bindComplete;case 49:return v.parseComplete;case 51:return v.closeComplete;case 110:return v.noData;case 115:return v.portalSuspended;case 99:return v.copyDone;case 87:return v.replicationStart;case 73:return v.emptyQuery;case 68:return this.parseDataRowMessage(e,r,n);case 67:return this.parseCommandCompleteMessage(e,r,n);case 90:return this.parseReadyForQueryMessage(e,r,n);case 65:return this.parseNotificationMessage(e,r,n);case 82:return this.parseAuthenticationResponse(e,r,n);case 83:return this.parseParameterStatusMessage(e,r,n);case 75:return this.parseBackendKeyData(e,r,n);case 69:return this.parseErrorMessage(e,r,n,"error");case 78:return this.parseErrorMessage(e,r,n,"notice");case 84:return this.parseRowDescriptionMessage(e,r,n);case 116:return this.parseParameterDescriptionMessage(e,r,n);case 71:return this.parseCopyInMessage(e,r,n);case 72:return this.parseCopyOutMessage(e,r,n);case 100:return this.parseCopyData(e,r,n);default:return new v.DatabaseError("received invalid response: "+t.toString(16),r,"error")}}parseReadyForQueryMessage(e,t,r){this.reader.setBuffer(e,r);let n=this.reader.string(1);return new v.ReadyForQueryMessage(t,n)}parseCommandCompleteMessage(e,t,r){this.reader.setBuffer(e,r);let n=this.reader.cstring();return new v.CommandCompleteMessage(t,n)}parseCopyData(e,t,r){let n=r.slice(e,e+(t-4));return new v.CopyDataMessage(t,n)}parseCopyInMessage(e,t,r){return this.parseCopyMessage(e,t,r,"copyInResponse")}parseCopyOutMessage(e,t,r){return this.parseCopyMessage(e,t,r,"copyOutResponse")}parseCopyMessage(e,t,r,n){this.reader.setBuffer(e,r);let i=this.reader.byte()!==0,o=this.reader.int16(),a=new v.CopyResponse(t,n,i,o);for(let c=0;c<o;c++)a.columnTypes[c]=this.reader.int16();return a}parseNotificationMessage(e,t,r){this.reader.setBuffer(e,r);let n=this.reader.int32(),i=this.reader.cstring(),o=this.reader.cstring();return new v.NotificationResponseMessage(t,n,i,o)}parseRowDescriptionMessage(e,t,r){this.reader.setBuffer(e,r);let n=this.reader.int16(),i=new v.RowDescriptionMessage(t,n);for(let o=0;o<n;o++)i.fields[o]=this.parseField();return i}parseField(){let e=this.reader.cstring(),t=this.reader.uint32(),r=this.reader.int16(),n=this.reader.uint32(),i=this.reader.int16(),o=this.reader.int32(),a=this.reader.int16()===0?"text":"binary";return new v.Field(e,t,r,n,i,o,a)}parseParameterDescriptionMessage(e,t,r){this.reader.setBuffer(e,r);let n=this.reader.int16(),i=new v.ParameterDescriptionMessage(t,n);for(let o=0;o<n;o++)i.dataTypeIDs[o]=this.reader.int32();return i}parseDataRowMessage(e,t,r){this.reader.setBuffer(e,r);let n=this.reader.int16(),i=new Array(n);for(let o=0;o<n;o++){let a=this.reader.int32();i[o]=a===-1?null:this.reader.string(a)}return new v.DataRowMessage(t,i)}parseParameterStatusMessage(e,t,r){this.reader.setBuffer(e,r);let n=this.reader.cstring(),i=this.reader.cstring();return new v.ParameterStatusMessage(t,n,i)}parseBackendKeyData(e,t,r){this.reader.setBuffer(e,r);let n=this.reader.int32(),i=this.reader.int32();return new v.BackendKeyDataMessage(t,n,i)}parseAuthenticationResponse(e,t,r){this.reader.setBuffer(e,r);let n=this.reader.int32(),i={name:"authenticationOk",length:t};switch(n){case 0:break;case 3:i.length===8&&(i.name="authenticationCleartextPassword");break;case 5:if(i.length===12){i.name="authenticationMD5Password";let o=this.reader.bytes(4);return new v.AuthenticationMD5Password(t,o)}break;case 10:{i.name="authenticationSASL",i.mechanisms=[];let o;do o=this.reader.cstring(),o&&i.mechanisms.push(o);while(o)}break;case 11:i.name="authenticationSASLContinue",i.data=this.reader.string(t-8);break;case 12:i.name="authenticationSASLFinal",i.data=this.reader.string(t-8);break;default:throw new Error("Unknown authenticationOk message type "+n)}return i}parseErrorMessage(e,t,r,n){this.reader.setBuffer(e,r);let i={},o=this.reader.string(1);for(;o!=="\0";)i[o]=this.reader.cstring(),o=this.reader.string(1);let a=i.M,c=n==="notice"?new v.NoticeMessage(t,a):new v.DatabaseError(a,t,n);return c.severity=i.S,c.code=i.C,c.detail=i.D,c.hint=i.H,c.position=i.P,c.internalPosition=i.p,c.internalQuery=i.q,c.where=i.W,c.schema=i.s,c.table=i.t,c.column=i.c,c.dataType=i.d,c.constraint=i.n,c.file=i.F,c.line=i.L,c.routine=i.R,c}};Xe.Parser=es});var ts=g(Y=>{"use strict";Object.defineProperty(Y,"__esModule",{value:!0});Y.DatabaseError=Y.serialize=Y.parse=void 0;var ea=Vt();Object.defineProperty(Y,"DatabaseError",{enumerable:!0,get:function(){return ea.DatabaseError}});var ta=Wr();Object.defineProperty(Y,"serialize",{enumerable:!0,get:function(){return ta.serialize}});var sa=Jr();function ra(s,e){let t=new sa.Parser;return s.on("data",r=>t.parse(r,e)),new Promise(r=>s.on("end",()=>r()))}Y.parse=ra});var zr=g(ss=>{"use strict";Object.defineProperty(ss,"__esModule",{value:!0});ss.default={}});var en=g((Tu,Zr)=>{var{getStream:na,getSecureStream:ia}=ua();Zr.exports={getStream:na,getSecureStream:ia};function oa(){function s(t){let r=require("net");return new r.Socket}function e(t){return require("tls").connect(t)}return{getStream:s,getSecureStream:e}}function aa(){function s(t){let{CloudflareSocket:r}=zr();return new r(t)}function e(t){return t.socket.startTls(t),t.socket}return{getStream:s,getSecureStream:e}}function ca(){if(typeof navigator=="object"&&navigator!==null&&typeof navigator.userAgent=="string")return navigator.userAgent==="Cloudflare-Workers";if(typeof Response=="function"){let s=new Response(null,{cf:{thing:!0}});if(typeof s.cf=="object"&&s.cf!==null&&s.cf.thing)return!0}return!1}function ua(){return ca()?aa():oa()}});var ns=g((bu,tn)=>{"use strict";var la=require("events").EventEmitter,{parse:da,serialize:w}=ts(),{getStream:pa,getSecureStream:ha}=en(),fa=w.flush(),ma=w.sync(),_a=w.end(),rs=class extends la{constructor(e){super(),e=e||{},this.stream=e.stream||pa(e.ssl),typeof this.stream=="function"&&(this.stream=this.stream(e)),this._keepAlive=e.keepAlive,this._keepAliveInitialDelayMillis=e.keepAliveInitialDelayMillis,this.lastBuffer=!1,this.parsedStatements={},this.ssl=e.ssl||!1,this._ending=!1,this._emitMessage=!1;let t=this;this.on("newListener",function(r){r==="message"&&(t._emitMessage=!0)})}connect(e,t){let r=this;this._connecting=!0,this.stream.setNoDelay(!0),this.stream.connect(e,t),this.stream.once("connect",function(){r._keepAlive&&r.stream.setKeepAlive(!0,r._keepAliveInitialDelayMillis),r.emit("connect")});let n=function(i){r._ending&&(i.code==="ECONNRESET"||i.code==="EPIPE")||r.emit("error",i)};if(this.stream.on("error",n),this.stream.on("close",function(){r.emit("end")}),!this.ssl)return this.attachListeners(this.stream);this.stream.once("data",function(i){switch(i.toString("utf8")){case"S":break;case"N":return r.stream.end(),r.emit("error",new Error("The server does not support SSL connections"));default:return r.stream.end(),r.emit("error",new Error("There was an error establishing an SSL connection"))}let a={socket:r.stream};r.ssl!==!0&&(Object.assign(a,r.ssl),"key"in r.ssl&&(a.key=r.ssl.key));let c=require("net");c.isIP&&c.isIP(t)===0&&(a.servername=t);try{r.stream=ha(a)}catch(l){return r.emit("error",l)}r.attachListeners(r.stream),r.stream.on("error",n),r.emit("sslconnect")})}attachListeners(e){da(e,t=>{let r=t.name==="error"?"errorMessage":t.name;this._emitMessage&&this.emit("message",t),this.emit(r,t)})}requestSsl(){this.stream.write(w.requestSsl())}startup(e){this.stream.write(w.startup(e))}cancel(e,t){this._send(w.cancel(e,t))}password(e){this._send(w.password(e))}sendSASLInitialResponseMessage(e,t){this._send(w.sendSASLInitialResponseMessage(e,t))}sendSCRAMClientFinalMessage(e){this._send(w.sendSCRAMClientFinalMessage(e))}_send(e){return this.stream.writable?this.stream.write(e):!1}query(e){this._send(w.query(e))}parse(e){this._send(w.parse(e))}bind(e){this._send(w.bind(e))}execute(e){this._send(w.execute(e))}flush(){this.stream.writable&&this.stream.write(fa)}sync(){this._ending=!0,this._send(ma)}ref(){this.stream.ref()}unref(){this.stream.unref()}end(){if(this._ending=!0,!this._connecting||!this.stream.writable){this.stream.end();return}return this.stream.write(_a,()=>{this.stream.end()})}close(e){this._send(w.close(e))}describe(e){this._send(w.describe(e))}sendCopyFromChunk(e){this._send(w.copyData(e))}endCopyFrom(){this._send(w.copyDone())}sendCopyFail(e){this._send(w.copyFail(e))}};tn.exports=rs});var on=g((Ru,nn)=>{"use strict";var{Transform:Ea}=require("stream"),{StringDecoder:ga}=require("string_decoder"),K=Symbol("last"),We=Symbol("decoder");function Sa(s,e,t){let r;if(this.overflow){if(r=this[We].write(s).split(this.matcher),r.length===1)return t();r.shift(),this.overflow=!1}else this[K]+=this[We].write(s),r=this[K].split(this.matcher);this[K]=r.pop();for(let n=0;n<r.length;n++)try{rn(this,this.mapper(r[n]))}catch(i){return t(i)}if(this.overflow=this[K].length>this.maxLength,this.overflow&&!this.skipOverflow){t(new Error("maximum buffer reached"));return}t()}function ya(s){if(this[K]+=this[We].end(),this[K])try{rn(this,this.mapper(this[K]))}catch(e){return s(e)}s()}function rn(s,e){e!==void 0&&s.push(e)}function sn(s){return s}function Ta(s,e,t){switch(s=s||/\r?\n/,e=e||sn,t=t||{},arguments.length){case 1:typeof s=="function"?(e=s,s=/\r?\n/):typeof s=="object"&&!(s instanceof RegExp)&&!s[Symbol.split]&&(t=s,s=/\r?\n/);break;case 2:typeof s=="function"?(t=e,e=s,s=/\r?\n/):typeof e=="object"&&(t=e,e=sn)}t=Object.assign({},t),t.autoDestroy=!0,t.transform=Sa,t.flush=ya,t.readableObjectMode=!0;let r=new Ea(t);return r[K]="",r[We]=new ga("utf8"),r.matcher=s,r.mapper=e,r.maxLength=t.maxLength,r.skipOverflow=t.skipOverflow||!1,r.overflow=!1,r._destroy=function(n,i){this._writableState.errorEmitted=!1,i(n)},r}nn.exports=Ta});var un=g((Au,Q)=>{"use strict";var an=require("path"),ba=require("stream").Stream,Ra=on(),cn=require("util"),Aa=5432,Ve=process.platform==="win32",Ce=process.stderr,va=56,Ca=7,Oa=61440,Ia=32768;function wa(s){return(s&Oa)==Ia}var pe=["host","port","database","user","password"],is=pe.length,La=pe[is-1];function os(){var s=Ce instanceof ba&&Ce.writable===!0;if(s){var e=Array.prototype.slice.call(arguments).concat(`
`);Ce.write(cn.format.apply(cn,e))}}Object.defineProperty(Q.exports,"isWin",{get:function(){return Ve},set:function(s){Ve=s}});Q.exports.warnTo=function(s){var e=Ce;return Ce=s,e};Q.exports.getFileName=function(s){var e=s||process.env,t=e.PGPASSFILE||(Ve?an.join(e.APPDATA||"./","postgresql","pgpass.conf"):an.join(e.HOME||"./",".pgpass"));return t};Q.exports.usePgPass=function(s,e){return Object.prototype.hasOwnProperty.call(process.env,"PGPASSWORD")?!1:Ve?!0:(e=e||"<unkn>",wa(s.mode)?s.mode&(va|Ca)?(os('WARNING: password file "%s" has group or world access; permissions should be u=rw (0600) or less',e),!1):!0:(os('WARNING: password file "%s" is not a plain file',e),!1))};var Na=Q.exports.match=function(s,e){return pe.slice(0,-1).reduce(function(t,r,n){return n==1&&Number(s[r]||Aa)===Number(e[r])?t&&!0:t&&(e[r]==="*"||e[r]===s[r])},!0)};Q.exports.getPassword=function(s,e,t){var r,n=e.pipe(Ra());function i(c){var l=Ma(c);l&&Da(l)&&Na(s,l)&&(r=l[La],n.end())}var o=function(){e.destroy(),t(r)},a=function(c){e.destroy(),os("WARNING: error on reading file: %s",c),t(void 0)};e.on("error",a),n.on("data",i).on("end",o).on("error",a)};var Ma=Q.exports.parseLine=function(s){if(s.length<11||s.match(/^\s+#/))return null;for(var e="",t="",r=0,n=0,i=0,o={},a=!1,c=function(p,f,_){var u=s.substring(f,_);Object.hasOwnProperty.call(process.env,"PGPASS_NO_DEESCAPE")||(u=u.replace(/\\([:\\])/g,"$1")),o[pe[p]]=u},l=0;l<s.length-1;l+=1){if(e=s.charAt(l+1),t=s.charAt(l),a=r==is-1,a){c(r,n);break}l>=0&&e==":"&&t!=="\\"&&(c(r,n,l+1),n=l+2,r+=1)}return o=Object.keys(o).length===is?o:null,o},Da=Q.exports.isValidEntry=function(s){for(var e={0:function(o){return o.length>0},1:function(o){return o==="*"?!0:(o=Number(o),isFinite(o)&&o>0&&o<9007199254740992&&Math.floor(o)===o)},2:function(o){return o.length>0},3:function(o){return o.length>0},4:function(o){return o.length>0}},t=0;t<pe.length;t+=1){var r=e[t],n=s[pe[t]]||"",i=r(n);if(!i)return!1}return!0}});var dn=g((Cu,as)=>{"use strict";var vu=require("path"),ln=require("fs"),Ye=un();as.exports=function(s,e){var t=Ye.getFileName();ln.stat(t,function(r,n){if(r||!Ye.usePgPass(n,t))return e(void 0);var i=ln.createReadStream(t);Ye.getPassword(s,i,e)})};as.exports.warnTo=Ye.warnTo});var mn=g((Ou,fn)=>{"use strict";var ka=require("events").EventEmitter,pn=ae(),cs=Nr(),xa=qe(),Pa=Lt(),hn=Qr(),Ua=Ae(),Ba=ns(),Fa=Ot(),Ke=class extends ka{constructor(e){super(),this.connectionParameters=new Pa(e),this.user=this.connectionParameters.user,this.database=this.connectionParameters.database,this.port=this.connectionParameters.port,this.host=this.connectionParameters.host,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:this.connectionParameters.password}),this.replication=this.connectionParameters.replication;let t=e||{};this._Promise=t.Promise||global.Promise,this._types=new xa(t.types),this._ending=!1,this._ended=!1,this._connecting=!1,this._connected=!1,this._connectionError=!1,this._queryable=!0,this.enableChannelBinding=!!t.enableChannelBinding,this.connection=t.connection||new Ba({stream:t.stream,ssl:this.connectionParameters.ssl,keepAlive:t.keepAlive||!1,keepAliveInitialDelayMillis:t.keepAliveInitialDelayMillis||0,encoding:this.connectionParameters.client_encoding||"utf8"}),this.queryQueue=[],this.binary=t.binary||Ua.binary,this.processID=null,this.secretKey=null,this.ssl=this.connectionParameters.ssl||!1,this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this._connectionTimeoutMillis=t.connectionTimeoutMillis||0}_errorAllQueries(e){let t=r=>{process.nextTick(()=>{r.handleError(e,this.connection)})};this.activeQuery&&(t(this.activeQuery),this.activeQuery=null),this.queryQueue.forEach(t),this.queryQueue.length=0}_connect(e){let t=this,r=this.connection;if(this._connectionCallback=e,this._connecting||this._connected){let n=new Error("Client has already been connected. You cannot reuse a client.");process.nextTick(()=>{e(n)});return}this._connecting=!0,this._connectionTimeoutMillis>0&&(this.connectionTimeoutHandle=setTimeout(()=>{r._ending=!0,r.stream.destroy(new Error("timeout expired"))},this._connectionTimeoutMillis),this.connectionTimeoutHandle.unref&&this.connectionTimeoutHandle.unref()),this.host&&this.host.indexOf("/")===0?r.connect(this.host+"/.s.PGSQL."+this.port):r.connect(this.port,this.host),r.on("connect",function(){t.ssl?r.requestSsl():r.startup(t.getStartupConf())}),r.on("sslconnect",function(){r.startup(t.getStartupConf())}),this._attachListeners(r),r.once("end",()=>{let n=this._ending?new Error("Connection terminated"):new Error("Connection terminated unexpectedly");clearTimeout(this.connectionTimeoutHandle),this._errorAllQueries(n),this._ended=!0,this._ending||(this._connecting&&!this._connectionError?this._connectionCallback?this._connectionCallback(n):this._handleErrorEvent(n):this._connectionError||this._handleErrorEvent(n)),process.nextTick(()=>{this.emit("end")})})}connect(e){if(e){this._connect(e);return}return new this._Promise((t,r)=>{this._connect(n=>{n?r(n):t()})})}_attachListeners(e){e.on("authenticationCleartextPassword",this._handleAuthCleartextPassword.bind(this)),e.on("authenticationMD5Password",this._handleAuthMD5Password.bind(this)),e.on("authenticationSASL",this._handleAuthSASL.bind(this)),e.on("authenticationSASLContinue",this._handleAuthSASLContinue.bind(this)),e.on("authenticationSASLFinal",this._handleAuthSASLFinal.bind(this)),e.on("backendKeyData",this._handleBackendKeyData.bind(this)),e.on("error",this._handleErrorEvent.bind(this)),e.on("errorMessage",this._handleErrorMessage.bind(this)),e.on("readyForQuery",this._handleReadyForQuery.bind(this)),e.on("notice",this._handleNotice.bind(this)),e.on("rowDescription",this._handleRowDescription.bind(this)),e.on("dataRow",this._handleDataRow.bind(this)),e.on("portalSuspended",this._handlePortalSuspended.bind(this)),e.on("emptyQuery",this._handleEmptyQuery.bind(this)),e.on("commandComplete",this._handleCommandComplete.bind(this)),e.on("parseComplete",this._handleParseComplete.bind(this)),e.on("copyInResponse",this._handleCopyInResponse.bind(this)),e.on("copyData",this._handleCopyData.bind(this)),e.on("notification",this._handleNotification.bind(this))}_checkPgPass(e){let t=this.connection;if(typeof this.password=="function")this._Promise.resolve().then(()=>this.password()).then(r=>{if(r!==void 0){if(typeof r!="string"){t.emit("error",new TypeError("Password must be a string"));return}this.connectionParameters.password=this.password=r}else this.connectionParameters.password=this.password=null;e()}).catch(r=>{t.emit("error",r)});else if(this.password!==null)e();else try{dn()(this.connectionParameters,n=>{n!==void 0&&(this.connectionParameters.password=this.password=n),e()})}catch(r){this.emit("error",r)}}_handleAuthCleartextPassword(e){this._checkPgPass(()=>{this.connection.password(this.password)})}_handleAuthMD5Password(e){this._checkPgPass(async()=>{try{let t=await Fa.postgresMd5PasswordHash(this.user,this.password,e.salt);this.connection.password(t)}catch(t){this.emit("error",t)}})}_handleAuthSASL(e){this._checkPgPass(()=>{try{this.saslSession=cs.startSession(e.mechanisms,this.enableChannelBinding&&this.connection.stream),this.connection.sendSASLInitialResponseMessage(this.saslSession.mechanism,this.saslSession.response)}catch(t){this.connection.emit("error",t)}})}async _handleAuthSASLContinue(e){try{await cs.continueSession(this.saslSession,this.password,e.data,this.enableChannelBinding&&this.connection.stream),this.connection.sendSCRAMClientFinalMessage(this.saslSession.response)}catch(t){this.connection.emit("error",t)}}_handleAuthSASLFinal(e){try{cs.finalizeSession(this.saslSession,e.data),this.saslSession=null}catch(t){this.connection.emit("error",t)}}_handleBackendKeyData(e){this.processID=e.processID,this.secretKey=e.secretKey}_handleReadyForQuery(e){this._connecting&&(this._connecting=!1,this._connected=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback&&(this._connectionCallback(null,this),this._connectionCallback=null),this.emit("connect"));let{activeQuery:t}=this;this.activeQuery=null,this.readyForQuery=!0,t&&t.handleReadyForQuery(this.connection),this._pulseQueryQueue()}_handleErrorWhileConnecting(e){if(!this._connectionError){if(this._connectionError=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback)return this._connectionCallback(e);this.emit("error",e)}}_handleErrorEvent(e){if(this._connecting)return this._handleErrorWhileConnecting(e);this._queryable=!1,this._errorAllQueries(e),this.emit("error",e)}_handleErrorMessage(e){if(this._connecting)return this._handleErrorWhileConnecting(e);let t=this.activeQuery;if(!t){this._handleErrorEvent(e);return}this.activeQuery=null,t.handleError(e,this.connection)}_handleRowDescription(e){this.activeQuery.handleRowDescription(e)}_handleDataRow(e){this.activeQuery.handleDataRow(e)}_handlePortalSuspended(e){this.activeQuery.handlePortalSuspended(this.connection)}_handleEmptyQuery(e){this.activeQuery.handleEmptyQuery(this.connection)}_handleCommandComplete(e){if(this.activeQuery==null){let t=new Error("Received unexpected commandComplete message from backend.");this._handleErrorEvent(t);return}this.activeQuery.handleCommandComplete(e,this.connection)}_handleParseComplete(){if(this.activeQuery==null){let e=new Error("Received unexpected parseComplete message from backend.");this._handleErrorEvent(e);return}this.activeQuery.name&&(this.connection.parsedStatements[this.activeQuery.name]=this.activeQuery.text)}_handleCopyInResponse(e){this.activeQuery.handleCopyInResponse(this.connection)}_handleCopyData(e){this.activeQuery.handleCopyData(e,this.connection)}_handleNotification(e){this.emit("notification",e)}_handleNotice(e){this.emit("notice",e)}getStartupConf(){let e=this.connectionParameters,t={user:e.user,database:e.database},r=e.application_name||e.fallback_application_name;return r&&(t.application_name=r),e.replication&&(t.replication=""+e.replication),e.statement_timeout&&(t.statement_timeout=String(parseInt(e.statement_timeout,10))),e.lock_timeout&&(t.lock_timeout=String(parseInt(e.lock_timeout,10))),e.idle_in_transaction_session_timeout&&(t.idle_in_transaction_session_timeout=String(parseInt(e.idle_in_transaction_session_timeout,10))),e.options&&(t.options=e.options),t}cancel(e,t){if(e.activeQuery===t){let r=this.connection;this.host&&this.host.indexOf("/")===0?r.connect(this.host+"/.s.PGSQL."+this.port):r.connect(this.port,this.host),r.on("connect",function(){r.cancel(e.processID,e.secretKey)})}else e.queryQueue.indexOf(t)!==-1&&e.queryQueue.splice(e.queryQueue.indexOf(t),1)}setTypeParser(e,t,r){return this._types.setTypeParser(e,t,r)}getTypeParser(e,t){return this._types.getTypeParser(e,t)}escapeIdentifier(e){return pn.escapeIdentifier(e)}escapeLiteral(e){return pn.escapeLiteral(e)}_pulseQueryQueue(){if(this.readyForQuery===!0)if(this.activeQuery=this.queryQueue.shift(),this.activeQuery){this.readyForQuery=!1,this.hasExecuted=!0;let e=this.activeQuery.submit(this.connection);e&&process.nextTick(()=>{this.activeQuery.handleError(e,this.connection),this.readyForQuery=!0,this._pulseQueryQueue()})}else this.hasExecuted&&(this.activeQuery=null,this.emit("drain"))}query(e,t,r){let n,i,o,a,c;if(e==null)throw new TypeError("Client was passed a null or undefined query");return typeof e.submit=="function"?(o=e.query_timeout||this.connectionParameters.query_timeout,i=n=e,typeof t=="function"&&(n.callback=n.callback||t)):(o=e.query_timeout||this.connectionParameters.query_timeout,n=new hn(e,t,r),n.callback||(i=new this._Promise((l,p)=>{n.callback=(f,_)=>f?p(f):l(_)}).catch(l=>{throw Error.captureStackTrace(l),l}))),o&&(c=n.callback,a=setTimeout(()=>{let l=new Error("Query read timeout");process.nextTick(()=>{n.handleError(l,this.connection)}),c(l),n.callback=()=>{};let p=this.queryQueue.indexOf(n);p>-1&&this.queryQueue.splice(p,1),this._pulseQueryQueue()},o),n.callback=(l,p)=>{clearTimeout(a),c(l,p)}),this.binary&&!n.binary&&(n.binary=!0),n._result&&!n._result._types&&(n._result._types=this._types),this._queryable?this._ending?(process.nextTick(()=>{n.handleError(new Error("Client was closed and is not queryable"),this.connection)}),i):(this.queryQueue.push(n),this._pulseQueryQueue(),i):(process.nextTick(()=>{n.handleError(new Error("Client has encountered a connection error and is not queryable"),this.connection)}),i)}ref(){this.connection.ref()}unref(){this.connection.unref()}end(e){if(this._ending=!0,!this.connection._connecting||this._ended)if(e)e();else return this._Promise.resolve();if(this.activeQuery||!this._queryable?this.connection.stream.destroy():this.connection.end(),e)this.connection.once("end",e);else return new this._Promise(t=>{this.connection.once("end",t)})}};Ke.Query=hn;fn.exports=Ke});var Sn=g((Iu,gn)=>{"use strict";var $a=require("events").EventEmitter,_n=function(){},En=(s,e)=>{let t=s.findIndex(e);return t===-1?void 0:s.splice(t,1)[0]},us=class{constructor(e,t,r){this.client=e,this.idleListener=t,this.timeoutId=r}},he=class{constructor(e){this.callback=e}};function qa(){throw new Error("Release called on client which has already been released to the pool.")}function Je(s,e){if(e)return{callback:e,result:void 0};let t,r,n=function(o,a){o?t(o):r(a)},i=new s(function(o,a){r=o,t=a}).catch(o=>{throw Error.captureStackTrace(o),o});return{callback:n,result:i}}function ja(s,e){return function t(r){r.client=e,e.removeListener("error",t),e.on("error",()=>{s.log("additional client error after disconnection due to error",r)}),s._remove(e),s.emit("error",r,e)}}var ls=class extends $a{constructor(e,t){super(),this.options=Object.assign({},e),e!=null&&"password"in e&&Object.defineProperty(this.options,"password",{configurable:!0,enumerable:!1,writable:!0,value:e.password}),e!=null&&e.ssl&&e.ssl.key&&Object.defineProperty(this.options.ssl,"key",{enumerable:!1}),this.options.max=this.options.max||this.options.poolSize||10,this.options.min=this.options.min||0,this.options.maxUses=this.options.maxUses||1/0,this.options.allowExitOnIdle=this.options.allowExitOnIdle||!1,this.options.maxLifetimeSeconds=this.options.maxLifetimeSeconds||0,this.log=this.options.log||function(){},this.Client=this.options.Client||t||ds().Client,this.Promise=this.options.Promise||global.Promise,typeof this.options.idleTimeoutMillis>"u"&&(this.options.idleTimeoutMillis=1e4),this._clients=[],this._idle=[],this._expired=new WeakSet,this._pendingQueue=[],this._endCallback=void 0,this.ending=!1,this.ended=!1}_isFull(){return this._clients.length>=this.options.max}_isAboveMin(){return this._clients.length>this.options.min}_pulseQueue(){if(this.log("pulse queue"),this.ended){this.log("pulse queue ended");return}if(this.ending){this.log("pulse queue on ending"),this._idle.length&&this._idle.slice().map(t=>{this._remove(t.client)}),this._clients.length||(this.ended=!0,this._endCallback());return}if(!this._pendingQueue.length){this.log("no queued requests");return}if(!this._idle.length&&this._isFull())return;let e=this._pendingQueue.shift();if(this._idle.length){let t=this._idle.pop();clearTimeout(t.timeoutId);let r=t.client;r.ref&&r.ref();let n=t.idleListener;return this._acquireClient(r,e,n,!1)}if(!this._isFull())return this.newClient(e);throw new Error("unexpected condition")}_remove(e,t){let r=En(this._idle,i=>i.client===e);r!==void 0&&clearTimeout(r.timeoutId),this._clients=this._clients.filter(i=>i!==e);let n=this;e.end(()=>{n.emit("remove",e),typeof t=="function"&&t()})}connect(e){if(this.ending){let n=new Error("Cannot use a pool after calling end on the pool");return e?e(n):this.Promise.reject(n)}let t=Je(this.Promise,e),r=t.result;if(this._isFull()||this._idle.length){if(this._idle.length&&process.nextTick(()=>this._pulseQueue()),!this.options.connectionTimeoutMillis)return this._pendingQueue.push(new he(t.callback)),r;let n=(a,c,l)=>{clearTimeout(o),t.callback(a,c,l)},i=new he(n),o=setTimeout(()=>{En(this._pendingQueue,a=>a.callback===n),i.timedOut=!0,t.callback(new Error("timeout exceeded when trying to connect"))},this.options.connectionTimeoutMillis);return o.unref&&o.unref(),this._pendingQueue.push(i),r}return this.newClient(new he(t.callback)),r}newClient(e){let t=new this.Client(this.options);this._clients.push(t);let r=ja(this,t);this.log("checking client timeout");let n,i=!1;this.options.connectionTimeoutMillis&&(n=setTimeout(()=>{this.log("ending client due to timeout"),i=!0,t.connection?t.connection.stream.destroy():t.end()},this.options.connectionTimeoutMillis)),this.log("connecting new client"),t.connect(o=>{if(n&&clearTimeout(n),t.on("error",r),o)this.log("client failed to connect",o),this._clients=this._clients.filter(a=>a!==t),i&&(o=new Error("Connection terminated due to connection timeout",{cause:o})),this._pulseQueue(),e.timedOut||e.callback(o,void 0,_n);else{if(this.log("new client connected"),this.options.maxLifetimeSeconds!==0){let a=setTimeout(()=>{this.log("ending client due to expired lifetime"),this._expired.add(t),this._idle.findIndex(l=>l.client===t)!==-1&&this._acquireClient(t,new he((l,p,f)=>f()),r,!1)},this.options.maxLifetimeSeconds*1e3);a.unref(),t.once("end",()=>clearTimeout(a))}return this._acquireClient(t,e,r,!0)}})}_acquireClient(e,t,r,n){n&&this.emit("connect",e),this.emit("acquire",e),e.release=this._releaseOnce(e,r),e.removeListener("error",r),t.timedOut?n&&this.options.verify?this.options.verify(e,e.release):e.release():n&&this.options.verify?this.options.verify(e,i=>{if(i)return e.release(i),t.callback(i,void 0,_n);t.callback(void 0,e,e.release)}):t.callback(void 0,e,e.release)}_releaseOnce(e,t){let r=!1;return n=>{r&&qa(),r=!0,this._release(e,t,n)}}_release(e,t,r){if(e.on("error",t),e._poolUseCount=(e._poolUseCount||0)+1,this.emit("release",r,e),r||this.ending||!e._queryable||e._ending||e._poolUseCount>=this.options.maxUses)return e._poolUseCount>=this.options.maxUses&&this.log("remove expended client"),this._remove(e,this._pulseQueue.bind(this));if(this._expired.has(e))return this.log("remove expired client"),this._expired.delete(e),this._remove(e,this._pulseQueue.bind(this));let i;this.options.idleTimeoutMillis&&this._isAboveMin()&&(i=setTimeout(()=>{this.log("remove idle client"),this._remove(e,this._pulseQueue.bind(this))},this.options.idleTimeoutMillis),this.options.allowExitOnIdle&&i.unref()),this.options.allowExitOnIdle&&e.unref(),this._idle.push(new us(e,t,i)),this._pulseQueue()}query(e,t,r){if(typeof e=="function"){let i=Je(this.Promise,e);return setImmediate(function(){return i.callback(new Error("Passing a function as the first parameter to pool.query is not supported"))}),i.result}typeof t=="function"&&(r=t,t=void 0);let n=Je(this.Promise,r);return r=n.callback,this.connect((i,o)=>{if(i)return r(i);let a=!1,c=l=>{a||(a=!0,o.release(l),r(l))};o.once("error",c),this.log("dispatching query");try{o.query(e,t,(l,p)=>{if(this.log("query dispatched"),o.removeListener("error",c),!a)return a=!0,o.release(l),l?r(l):r(void 0,p)})}catch(l){return o.release(l),r(l)}}),n.result}end(e){if(this.log("ending"),this.ending){let r=new Error("Called end on pool more than once");return e?e(r):this.Promise.reject(r)}this.ending=!0;let t=Je(this.Promise,e);return this._endCallback=t.callback,this._pulseQueue(),t.result}get waitingCount(){return this._pendingQueue.length}get idleCount(){return this._idle.length}get expiredCount(){return this._clients.reduce((e,t)=>e+(this._expired.has(t)?1:0),0)}get totalCount(){return this._clients.length}};gn.exports=ls});var bn=g((wu,Tn)=>{"use strict";var yn=require("events").EventEmitter,Ha=require("util"),ps=ae(),fe=Tn.exports=function(s,e,t){yn.call(this),s=ps.normalizeQueryConfig(s,e,t),this.text=s.text,this.values=s.values,this.name=s.name,this.queryMode=s.queryMode,this.callback=s.callback,this.state="new",this._arrayMode=s.rowMode==="array",this._emitRowEvents=!1,this.on("newListener",function(r){r==="row"&&(this._emitRowEvents=!0)}.bind(this))};Ha.inherits(fe,yn);var Qa={sqlState:"code",statementPosition:"position",messagePrimary:"message",context:"where",schemaName:"schema",tableName:"table",columnName:"column",dataTypeName:"dataType",constraintName:"constraint",sourceFile:"file",sourceLine:"line",sourceFunction:"routine"};fe.prototype.handleError=function(s){let e=this.native.pq.resultErrorFields();if(e)for(let t in e){let r=Qa[t]||t;s[r]=e[t]}this.callback?this.callback(s):this.emit("error",s),this.state="error"};fe.prototype.then=function(s,e){return this._getPromise().then(s,e)};fe.prototype.catch=function(s){return this._getPromise().catch(s)};fe.prototype._getPromise=function(){return this._promise?this._promise:(this._promise=new Promise(function(s,e){this._once("end",s),this._once("error",e)}.bind(this)),this._promise)};fe.prototype.submit=function(s){this.state="running";let e=this;this.native=s.native,s.native.arrayMode=this._arrayMode;let t=function(r,n,i){if(s.native.arrayMode=!1,setImmediate(function(){e.emit("_done")}),r)return e.handleError(r);e._emitRowEvents&&(i.length>1?n.forEach((o,a)=>{o.forEach(c=>{e.emit("row",c,i[a])})}):n.forEach(function(o){e.emit("row",o,i)})),e.state="end",e.emit("end",i),e.callback&&e.callback(null,i)};if(process.domain&&(t=process.domain.bind(t)),this.name){this.name.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",this.name,this.name.length),console.error("This can cause conflicts and silent errors executing queries"));let r=(this.values||[]).map(ps.prepareValue);if(s.namedQueries[this.name]){if(this.text&&s.namedQueries[this.name]!==this.text){let n=new Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`);return t(n)}return s.native.execute(this.name,r,t)}return s.native.prepare(this.name,this.text,r.length,function(n){return n?t(n):(s.namedQueries[e.name]=e.text,e.native.execute(e.name,r,t))})}else if(this.values){if(!Array.isArray(this.values)){let n=new Error("Query values must be an array");return t(n)}let r=this.values.map(ps.prepareValue);s.native.query(this.text,r,t)}else this.queryMode==="extended"?s.native.query(this.text,[],t):s.native.query(this.text,t)}});var On=g((Lu,Cn)=>{"use strict";var Rn;try{Rn=require("pg-native")}catch(s){throw s}var Ga=qe(),An=require("events").EventEmitter,Xa=require("util"),Wa=Lt(),vn=bn(),x=Cn.exports=function(s){An.call(this),s=s||{},this._Promise=s.Promise||global.Promise,this._types=new Ga(s.types),this.native=new Rn({types:this._types}),this._queryQueue=[],this._ending=!1,this._connecting=!1,this._connected=!1,this._queryable=!0;let e=this.connectionParameters=new Wa(s);s.nativeConnectionString&&(e.nativeConnectionString=s.nativeConnectionString),this.user=e.user,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:e.password}),this.database=e.database,this.host=e.host,this.port=e.port,this.namedQueries={}};x.Query=vn;Xa.inherits(x,An);x.prototype._errorAllQueries=function(s){let e=t=>{process.nextTick(()=>{t.native=this.native,t.handleError(s)})};this._hasActiveQuery()&&(e(this._activeQuery),this._activeQuery=null),this._queryQueue.forEach(e),this._queryQueue.length=0};x.prototype._connect=function(s){let e=this;if(this._connecting){process.nextTick(()=>s(new Error("Client has already been connected. You cannot reuse a client.")));return}this._connecting=!0,this.connectionParameters.getLibpqConnectionString(function(t,r){if(e.connectionParameters.nativeConnectionString&&(r=e.connectionParameters.nativeConnectionString),t)return s(t);e.native.connect(r,function(n){if(n)return e.native.end(),s(n);e._connected=!0,e.native.on("error",function(i){e._queryable=!1,e._errorAllQueries(i),e.emit("error",i)}),e.native.on("notification",function(i){e.emit("notification",{channel:i.relname,payload:i.extra})}),e.emit("connect"),e._pulseQueryQueue(!0),s()})})};x.prototype.connect=function(s){if(s){this._connect(s);return}return new this._Promise((e,t)=>{this._connect(r=>{r?t(r):e()})})};x.prototype.query=function(s,e,t){let r,n,i,o,a;if(s==null)throw new TypeError("Client was passed a null or undefined query");if(typeof s.submit=="function")i=s.query_timeout||this.connectionParameters.query_timeout,n=r=s,typeof e=="function"&&(s.callback=e);else if(i=s.query_timeout||this.connectionParameters.query_timeout,r=new vn(s,e,t),!r.callback){let c,l;n=new this._Promise((p,f)=>{c=p,l=f}).catch(p=>{throw Error.captureStackTrace(p),p}),r.callback=(p,f)=>p?l(p):c(f)}return i&&(a=r.callback,o=setTimeout(()=>{let c=new Error("Query read timeout");process.nextTick(()=>{r.handleError(c,this.connection)}),a(c),r.callback=()=>{};let l=this._queryQueue.indexOf(r);l>-1&&this._queryQueue.splice(l,1),this._pulseQueryQueue()},i),r.callback=(c,l)=>{clearTimeout(o),a(c,l)}),this._queryable?this._ending?(r.native=this.native,process.nextTick(()=>{r.handleError(new Error("Client was closed and is not queryable"))}),n):(this._queryQueue.push(r),this._pulseQueryQueue(),n):(r.native=this.native,process.nextTick(()=>{r.handleError(new Error("Client has encountered a connection error and is not queryable"))}),n)};x.prototype.end=function(s){let e=this;this._ending=!0,this._connected||this.once("connect",this.end.bind(this,s));let t;return s||(t=new this._Promise(function(r,n){s=i=>i?n(i):r()})),this.native.end(function(){e._errorAllQueries(new Error("Connection terminated")),process.nextTick(()=>{e.emit("end"),s&&s()})}),t};x.prototype._hasActiveQuery=function(){return this._activeQuery&&this._activeQuery.state!=="error"&&this._activeQuery.state!=="end"};x.prototype._pulseQueryQueue=function(s){if(!this._connected||this._hasActiveQuery())return;let e=this._queryQueue.shift();if(!e){s||this.emit("drain");return}this._activeQuery=e,e.submit(this);let t=this;e.once("_done",function(){t._pulseQueryQueue()})};x.prototype.cancel=function(s){this._activeQuery===s?this.native.cancel(function(){}):this._queryQueue.indexOf(s)!==-1&&this._queryQueue.splice(this._queryQueue.indexOf(s),1)};x.prototype.ref=function(){};x.prototype.unref=function(){};x.prototype.setTypeParser=function(s,e,t){return this._types.setTypeParser(s,e,t)};x.prototype.getTypeParser=function(s,e){return this._types.getTypeParser(s,e)}});var hs=g((Nu,In)=>{"use strict";In.exports=On()});var ds=g((Du,Oe)=>{"use strict";var Va=mn(),Ya=Ae(),Ka=ns(),Ja=Mt(),za=ae(),Za=Sn(),ec=qe(),{DatabaseError:tc}=ts(),{escapeIdentifier:sc,escapeLiteral:rc}=ae(),nc=s=>class extends Za{constructor(t){super(t,s)}},fs=function(s){this.defaults=Ya,this.Client=s,this.Query=this.Client.Query,this.Pool=nc(this.Client),this._pools=[],this.Connection=Ka,this.types=Re(),this.DatabaseError=tc,this.TypeOverrides=ec,this.escapeIdentifier=sc,this.escapeLiteral=rc,this.Result=Ja,this.utils=za};typeof process.env.NODE_PG_FORCE_NATIVE<"u"?Oe.exports=new fs(hs()):(Oe.exports=new fs(Va),Object.defineProperty(Oe.exports,"native",{configurable:!0,enumerable:!1,get(){let s=null;try{s=new fs(hs())}catch(e){if(e.code!=="MODULE_NOT_FOUND")throw e}return Object.defineProperty(Oe.exports,"native",{value:s}),s}}))});var F,ku,wn,xu,Pu,Uu,Bu,Fu,$u,qu,ju,Hu,Ln=_e(()=>{F=rt(ds(),1),ku=F.default.Client,wn=F.default.Pool,xu=F.default.Connection,Pu=F.default.types,Uu=F.default.Query,Bu=F.default.DatabaseError,Fu=F.default.escapeIdentifier,$u=F.default.escapeLiteral,qu=F.default.Result,ju=F.default.TypeOverrides,Hu=F.default.defaults});var kn={};bs(kn,{checkHealth:()=>cc,closePool:()=>ac,getClient:()=>Dn,getPool:()=>ms,initPool:()=>Nn,query:()=>Mn,transaction:()=>oc});function ic(){return{connectionString:process.env.CLAUDE_MEM_DATABASE_URL,max:10,min:2,idleTimeoutMillis:3e4,connectionTimeoutMillis:5e3,keepAlive:!0,keepAliveInitialDelayMillis:1e4}}function Nn(s){if($)return $;let e={...ic(),...s};if(!e.connectionString)throw new Error("CLAUDE_MEM_DATABASE_URL is required for PostgreSQL backend");return $=new wn(e),$.on("error",t=>{N.error("PG_POOL","Unexpected error on idle client",{},t)}),$.on("connect",()=>{N.debug("PG_POOL","New client connected to pool")}),N.info("PG_POOL","PostgreSQL connection pool initialized",{max:e.max,connectionString:uc(e.connectionString)}),$}function ms(){return $||Nn()}async function Mn(s,e){let t=Date.now(),r=await ms().query(s,e),n=Date.now()-t;return N.debug("PG_QUERY","Executed query",{text:s.substring(0,100),duration:n,rowCount:r.rowCount}),r}async function Dn(){return ms().connect()}async function oc(s){let e=await Dn();try{await e.query("BEGIN");let t=await s(e);return await e.query("COMMIT"),t}catch(t){throw await e.query("ROLLBACK"),t}finally{e.release()}}async function ac(){$&&(N.info("PG_POOL","Closing PostgreSQL connection pool"),await $.end(),$=null)}async function cc(){try{return(await Mn("SELECT 1 as health")).rows[0]?.health===1}catch(s){return N.error("PG_POOL","Health check failed",{},s),!1}}function uc(s){try{let e=new URL(s);return e.password&&(e.password="***"),e.toString()}catch{return"[invalid connection string]"}}var $,xn=_e(()=>{"use strict";Ln();Ee();$=null});var Ec={};bs(Ec,{generateContext:()=>_c});module.exports=Xn(Ec);var Ie=rt(require("path"),1),Ze=require("os"),me=require("fs");var xs=require("bun:sqlite");var M=require("path"),Ls=require("os"),Ns=require("fs");var Ms=require("url");xe();var Vn={};function Wn(){return typeof __dirname<"u"?__dirname:(0,M.dirname)((0,Ms.fileURLToPath)(Vn.url))}var Lc=Wn(),H=W.get("CLAUDE_MEM_DATA_DIR"),ut=process.env.CLAUDE_CONFIG_DIR||(0,M.join)((0,Ls.homedir)(),".claude"),Nc=(0,M.join)(H,"archives"),Mc=(0,M.join)(H,"logs"),Dc=(0,M.join)(H,"trash"),kc=(0,M.join)(H,"backups"),xc=(0,M.join)(H,"settings.json"),Ds=(0,M.join)(H,"claude-mem.db"),Pc=(0,M.join)(H,"vector-db"),Uc=(0,M.join)(ut,"settings.json"),Bc=(0,M.join)(ut,"commands"),Fc=(0,M.join)(ut,"CLAUDE.md");function ks(s){(0,Ns.mkdirSync)(s,{recursive:!0})}Ee();var Pe=class{db;constructor(){ks(H),this.db=new xs.Database(Ds),this.db.run("PRAGMA journal_mode = WAL"),this.db.run("PRAGMA synchronous = NORMAL"),this.db.run("PRAGMA foreign_keys = ON"),this.initializeSchema(),this.ensureWorkerPortColumn(),this.ensurePromptTrackingColumns(),this.removeSessionSummariesUniqueConstraint(),this.addObservationHierarchicalFields(),this.makeObservationsTextNullable(),this.createUserPromptsTable(),this.ensureDiscoveryTokensColumn(),this.createPendingMessagesTable()}initializeSchema(){try{this.db.run(`
        CREATE TABLE IF NOT EXISTS schema_versions (
          id INTEGER PRIMARY KEY,
          version INTEGER UNIQUE NOT NULL,
          applied_at TEXT NOT NULL
        )
      `);let e=this.db.prepare("SELECT version FROM schema_versions ORDER BY version").all();(e.length>0?Math.max(...e.map(r=>r.version)):0)===0&&(console.log("[SessionStore] Initializing fresh database with migration004..."),this.db.run(`
          CREATE TABLE IF NOT EXISTS sdk_sessions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            claude_session_id TEXT UNIQUE NOT NULL,
            sdk_session_id TEXT UNIQUE,
            project TEXT NOT NULL,
            user_prompt TEXT,
            started_at TEXT NOT NULL,
            started_at_epoch INTEGER NOT NULL,
            completed_at TEXT,
            completed_at_epoch INTEGER,
            status TEXT CHECK(status IN ('active', 'completed', 'failed')) NOT NULL DEFAULT 'active'
          );

          CREATE INDEX IF NOT EXISTS idx_sdk_sessions_claude_id ON sdk_sessions(claude_session_id);
          CREATE INDEX IF NOT EXISTS idx_sdk_sessions_sdk_id ON sdk_sessions(sdk_session_id);
          CREATE INDEX IF NOT EXISTS idx_sdk_sessions_project ON sdk_sessions(project);
          CREATE INDEX IF NOT EXISTS idx_sdk_sessions_status ON sdk_sessions(status);
          CREATE INDEX IF NOT EXISTS idx_sdk_sessions_started ON sdk_sessions(started_at_epoch DESC);

          CREATE TABLE IF NOT EXISTS observations (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sdk_session_id TEXT NOT NULL,
            project TEXT NOT NULL,
            text TEXT NOT NULL,
            type TEXT NOT NULL CHECK(type IN ('decision', 'bugfix', 'feature', 'refactor', 'discovery')),
            created_at TEXT NOT NULL,
            created_at_epoch INTEGER NOT NULL,
            FOREIGN KEY(sdk_session_id) REFERENCES sdk_sessions(sdk_session_id) ON DELETE CASCADE
          );

          CREATE INDEX IF NOT EXISTS idx_observations_sdk_session ON observations(sdk_session_id);
          CREATE INDEX IF NOT EXISTS idx_observations_project ON observations(project);
          CREATE INDEX IF NOT EXISTS idx_observations_type ON observations(type);
          CREATE INDEX IF NOT EXISTS idx_observations_created ON observations(created_at_epoch DESC);

          CREATE TABLE IF NOT EXISTS session_summaries (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sdk_session_id TEXT UNIQUE NOT NULL,
            project TEXT NOT NULL,
            request TEXT,
            investigated TEXT,
            learned TEXT,
            completed TEXT,
            next_steps TEXT,
            files_read TEXT,
            files_edited TEXT,
            notes TEXT,
            created_at TEXT NOT NULL,
            created_at_epoch INTEGER NOT NULL,
            FOREIGN KEY(sdk_session_id) REFERENCES sdk_sessions(sdk_session_id) ON DELETE CASCADE
          );

          CREATE INDEX IF NOT EXISTS idx_session_summaries_sdk_session ON session_summaries(sdk_session_id);
          CREATE INDEX IF NOT EXISTS idx_session_summaries_project ON session_summaries(project);
          CREATE INDEX IF NOT EXISTS idx_session_summaries_created ON session_summaries(created_at_epoch DESC);
        `),this.db.prepare("INSERT INTO schema_versions (version, applied_at) VALUES (?, ?)").run(4,new Date().toISOString()),console.log("[SessionStore] Migration004 applied successfully"))}catch(e){throw console.error("[SessionStore] Schema initialization error:",e.message),e}}ensureWorkerPortColumn(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(5))return;this.db.query("PRAGMA table_info(sdk_sessions)").all().some(n=>n.name==="worker_port")||(this.db.run("ALTER TABLE sdk_sessions ADD COLUMN worker_port INTEGER"),console.log("[SessionStore] Added worker_port column to sdk_sessions table")),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(5,new Date().toISOString())}catch(e){console.error("[SessionStore] Migration error:",e.message)}}ensurePromptTrackingColumns(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(6))return;this.db.query("PRAGMA table_info(sdk_sessions)").all().some(c=>c.name==="prompt_counter")||(this.db.run("ALTER TABLE sdk_sessions ADD COLUMN prompt_counter INTEGER DEFAULT 0"),console.log("[SessionStore] Added prompt_counter column to sdk_sessions table")),this.db.query("PRAGMA table_info(observations)").all().some(c=>c.name==="prompt_number")||(this.db.run("ALTER TABLE observations ADD COLUMN prompt_number INTEGER"),console.log("[SessionStore] Added prompt_number column to observations table")),this.db.query("PRAGMA table_info(session_summaries)").all().some(c=>c.name==="prompt_number")||(this.db.run("ALTER TABLE session_summaries ADD COLUMN prompt_number INTEGER"),console.log("[SessionStore] Added prompt_number column to session_summaries table")),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(6,new Date().toISOString())}catch(e){console.error("[SessionStore] Prompt tracking migration error:",e.message)}}removeSessionSummariesUniqueConstraint(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(7))return;if(!this.db.query("PRAGMA index_list(session_summaries)").all().some(n=>n.unique===1)){this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(7,new Date().toISOString());return}console.log("[SessionStore] Removing UNIQUE constraint from session_summaries.sdk_session_id..."),this.db.run("BEGIN TRANSACTION");try{this.db.run(`
          CREATE TABLE session_summaries_new (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sdk_session_id TEXT NOT NULL,
            project TEXT NOT NULL,
            request TEXT,
            investigated TEXT,
            learned TEXT,
            completed TEXT,
            next_steps TEXT,
            files_read TEXT,
            files_edited TEXT,
            notes TEXT,
            prompt_number INTEGER,
            created_at TEXT NOT NULL,
            created_at_epoch INTEGER NOT NULL,
            FOREIGN KEY(sdk_session_id) REFERENCES sdk_sessions(sdk_session_id) ON DELETE CASCADE
          )
        `),this.db.run(`
          INSERT INTO session_summaries_new
          SELECT id, sdk_session_id, project, request, investigated, learned,
                 completed, next_steps, files_read, files_edited, notes,
                 prompt_number, created_at, created_at_epoch
          FROM session_summaries
        `),this.db.run("DROP TABLE session_summaries"),this.db.run("ALTER TABLE session_summaries_new RENAME TO session_summaries"),this.db.run(`
          CREATE INDEX idx_session_summaries_sdk_session ON session_summaries(sdk_session_id);
          CREATE INDEX idx_session_summaries_project ON session_summaries(project);
          CREATE INDEX idx_session_summaries_created ON session_summaries(created_at_epoch DESC);
        `),this.db.run("COMMIT"),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(7,new Date().toISOString()),console.log("[SessionStore] Successfully removed UNIQUE constraint from session_summaries.sdk_session_id")}catch(n){throw this.db.run("ROLLBACK"),n}}catch(e){console.error("[SessionStore] Migration error (remove UNIQUE constraint):",e.message)}}addObservationHierarchicalFields(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(8))return;if(this.db.query("PRAGMA table_info(observations)").all().some(n=>n.name==="title")){this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(8,new Date().toISOString());return}console.log("[SessionStore] Adding hierarchical fields to observations table..."),this.db.run(`
        ALTER TABLE observations ADD COLUMN title TEXT;
        ALTER TABLE observations ADD COLUMN subtitle TEXT;
        ALTER TABLE observations ADD COLUMN facts TEXT;
        ALTER TABLE observations ADD COLUMN narrative TEXT;
        ALTER TABLE observations ADD COLUMN concepts TEXT;
        ALTER TABLE observations ADD COLUMN files_read TEXT;
        ALTER TABLE observations ADD COLUMN files_modified TEXT;
      `),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(8,new Date().toISOString()),console.log("[SessionStore] Successfully added hierarchical fields to observations table")}catch(e){console.error("[SessionStore] Migration error (add hierarchical fields):",e.message)}}makeObservationsTextNullable(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(9))return;let r=this.db.query("PRAGMA table_info(observations)").all().find(n=>n.name==="text");if(!r||r.notnull===0){this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(9,new Date().toISOString());return}console.log("[SessionStore] Making observations.text nullable..."),this.db.run("BEGIN TRANSACTION");try{this.db.run(`
          CREATE TABLE observations_new (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sdk_session_id TEXT NOT NULL,
            project TEXT NOT NULL,
            text TEXT,
            type TEXT NOT NULL CHECK(type IN ('decision', 'bugfix', 'feature', 'refactor', 'discovery', 'change')),
            title TEXT,
            subtitle TEXT,
            facts TEXT,
            narrative TEXT,
            concepts TEXT,
            files_read TEXT,
            files_modified TEXT,
            prompt_number INTEGER,
            created_at TEXT NOT NULL,
            created_at_epoch INTEGER NOT NULL,
            FOREIGN KEY(sdk_session_id) REFERENCES sdk_sessions(sdk_session_id) ON DELETE CASCADE
          )
        `),this.db.run(`
          INSERT INTO observations_new
          SELECT id, sdk_session_id, project, text, type, title, subtitle, facts,
                 narrative, concepts, files_read, files_modified, prompt_number,
                 created_at, created_at_epoch
          FROM observations
        `),this.db.run("DROP TABLE observations"),this.db.run("ALTER TABLE observations_new RENAME TO observations"),this.db.run(`
          CREATE INDEX idx_observations_sdk_session ON observations(sdk_session_id);
          CREATE INDEX idx_observations_project ON observations(project);
          CREATE INDEX idx_observations_type ON observations(type);
          CREATE INDEX idx_observations_created ON observations(created_at_epoch DESC);
        `),this.db.run("COMMIT"),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(9,new Date().toISOString()),console.log("[SessionStore] Successfully made observations.text nullable")}catch(n){throw this.db.run("ROLLBACK"),n}}catch(e){console.error("[SessionStore] Migration error (make text nullable):",e.message)}}createUserPromptsTable(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(10))return;if(this.db.query("PRAGMA table_info(user_prompts)").all().length>0){this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(10,new Date().toISOString());return}console.log("[SessionStore] Creating user_prompts table with FTS5 support..."),this.db.run("BEGIN TRANSACTION");try{this.db.run(`
          CREATE TABLE user_prompts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            claude_session_id TEXT NOT NULL,
            prompt_number INTEGER NOT NULL,
            prompt_text TEXT NOT NULL,
            created_at TEXT NOT NULL,
            created_at_epoch INTEGER NOT NULL,
            FOREIGN KEY(claude_session_id) REFERENCES sdk_sessions(claude_session_id) ON DELETE CASCADE
          );

          CREATE INDEX idx_user_prompts_claude_session ON user_prompts(claude_session_id);
          CREATE INDEX idx_user_prompts_created ON user_prompts(created_at_epoch DESC);
          CREATE INDEX idx_user_prompts_prompt_number ON user_prompts(prompt_number);
          CREATE INDEX idx_user_prompts_lookup ON user_prompts(claude_session_id, prompt_number);
        `),this.db.run(`
          CREATE VIRTUAL TABLE user_prompts_fts USING fts5(
            prompt_text,
            content='user_prompts',
            content_rowid='id'
          );
        `),this.db.run(`
          CREATE TRIGGER user_prompts_ai AFTER INSERT ON user_prompts BEGIN
            INSERT INTO user_prompts_fts(rowid, prompt_text)
            VALUES (new.id, new.prompt_text);
          END;

          CREATE TRIGGER user_prompts_ad AFTER DELETE ON user_prompts BEGIN
            INSERT INTO user_prompts_fts(user_prompts_fts, rowid, prompt_text)
            VALUES('delete', old.id, old.prompt_text);
          END;

          CREATE TRIGGER user_prompts_au AFTER UPDATE ON user_prompts BEGIN
            INSERT INTO user_prompts_fts(user_prompts_fts, rowid, prompt_text)
            VALUES('delete', old.id, old.prompt_text);
            INSERT INTO user_prompts_fts(rowid, prompt_text)
            VALUES (new.id, new.prompt_text);
          END;
        `),this.db.run("COMMIT"),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(10,new Date().toISOString()),console.log("[SessionStore] Successfully created user_prompts table with FTS5 support")}catch(r){throw this.db.run("ROLLBACK"),r}}catch(e){console.error("[SessionStore] Migration error (create user_prompts table):",e.message)}}ensureDiscoveryTokensColumn(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(11))return;this.db.query("PRAGMA table_info(observations)").all().some(o=>o.name==="discovery_tokens")||(this.db.run("ALTER TABLE observations ADD COLUMN discovery_tokens INTEGER DEFAULT 0"),console.log("[SessionStore] Added discovery_tokens column to observations table")),this.db.query("PRAGMA table_info(session_summaries)").all().some(o=>o.name==="discovery_tokens")||(this.db.run("ALTER TABLE session_summaries ADD COLUMN discovery_tokens INTEGER DEFAULT 0"),console.log("[SessionStore] Added discovery_tokens column to session_summaries table")),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(11,new Date().toISOString())}catch(e){throw console.error("[SessionStore] Discovery tokens migration error:",e.message),e}}createPendingMessagesTable(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(16))return;if(this.db.query("SELECT name FROM sqlite_master WHERE type='table' AND name='pending_messages'").all().length>0){this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(16,new Date().toISOString());return}console.log("[SessionStore] Creating pending_messages table..."),this.db.run(`
        CREATE TABLE pending_messages (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          session_db_id INTEGER NOT NULL,
          claude_session_id TEXT NOT NULL,
          message_type TEXT NOT NULL CHECK(message_type IN ('observation', 'summarize')),
          tool_name TEXT,
          tool_input TEXT,
          tool_response TEXT,
          cwd TEXT,
          last_user_message TEXT,
          last_assistant_message TEXT,
          prompt_number INTEGER,
          status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'processing', 'processed', 'failed')),
          retry_count INTEGER NOT NULL DEFAULT 0,
          created_at_epoch INTEGER NOT NULL,
          started_processing_at_epoch INTEGER,
          completed_at_epoch INTEGER,
          FOREIGN KEY (session_db_id) REFERENCES sdk_sessions(id) ON DELETE CASCADE
        )
      `),this.db.run("CREATE INDEX IF NOT EXISTS idx_pending_messages_session ON pending_messages(session_db_id)"),this.db.run("CREATE INDEX IF NOT EXISTS idx_pending_messages_status ON pending_messages(status)"),this.db.run("CREATE INDEX IF NOT EXISTS idx_pending_messages_claude_session ON pending_messages(claude_session_id)"),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(16,new Date().toISOString()),console.log("[SessionStore] pending_messages table created successfully")}catch(e){throw console.error("[SessionStore] Pending messages table migration error:",e.message),e}}getRecentSummaries(e,t=10){return this.db.prepare(`
      SELECT
        request, investigated, learned, completed, next_steps,
        files_read, files_edited, notes, prompt_number, created_at
      FROM session_summaries
      WHERE project = ?
      ORDER BY created_at_epoch DESC
      LIMIT ?
    `).all(e,t)}getRecentSummariesWithSessionInfo(e,t=3){return this.db.prepare(`
      SELECT
        sdk_session_id, request, learned, completed, next_steps,
        prompt_number, created_at
      FROM session_summaries
      WHERE project = ?
      ORDER BY created_at_epoch DESC
      LIMIT ?
    `).all(e,t)}getRecentObservations(e,t=20){return this.db.prepare(`
      SELECT type, text, prompt_number, created_at
      FROM observations
      WHERE project = ?
      ORDER BY created_at_epoch DESC
      LIMIT ?
    `).all(e,t)}getAllRecentObservations(e=100){return this.db.prepare(`
      SELECT id, type, title, subtitle, text, project, prompt_number, created_at, created_at_epoch
      FROM observations
      ORDER BY created_at_epoch DESC
      LIMIT ?
    `).all(e)}getAllRecentSummaries(e=50){return this.db.prepare(`
      SELECT id, request, investigated, learned, completed, next_steps,
             files_read, files_edited, notes, project, prompt_number,
             created_at, created_at_epoch
      FROM session_summaries
      ORDER BY created_at_epoch DESC
      LIMIT ?
    `).all(e)}getAllRecentUserPrompts(e=100){return this.db.prepare(`
      SELECT
        up.id,
        up.claude_session_id,
        s.project,
        up.prompt_number,
        up.prompt_text,
        up.created_at,
        up.created_at_epoch
      FROM user_prompts up
      LEFT JOIN sdk_sessions s ON up.claude_session_id = s.claude_session_id
      ORDER BY up.created_at_epoch DESC
      LIMIT ?
    `).all(e)}getAllProjects(){return this.db.prepare(`
      SELECT DISTINCT project
      FROM sdk_sessions
      WHERE project IS NOT NULL AND project != ''
      ORDER BY project ASC
    `).all().map(r=>r.project)}getLatestUserPrompt(e){return this.db.prepare(`
      SELECT
        up.*,
        s.sdk_session_id,
        s.project
      FROM user_prompts up
      JOIN sdk_sessions s ON up.claude_session_id = s.claude_session_id
      WHERE up.claude_session_id = ?
      ORDER BY up.created_at_epoch DESC
      LIMIT 1
    `).get(e)}getRecentSessionsWithStatus(e,t=3){return this.db.prepare(`
      SELECT * FROM (
        SELECT
          s.sdk_session_id,
          s.status,
          s.started_at,
          s.started_at_epoch,
          s.user_prompt,
          CASE WHEN sum.sdk_session_id IS NOT NULL THEN 1 ELSE 0 END as has_summary
        FROM sdk_sessions s
        LEFT JOIN session_summaries sum ON s.sdk_session_id = sum.sdk_session_id
        WHERE s.project = ? AND s.sdk_session_id IS NOT NULL
        GROUP BY s.sdk_session_id
        ORDER BY s.started_at_epoch DESC
        LIMIT ?
      )
      ORDER BY started_at_epoch ASC
    `).all(e,t)}getObservationsForSession(e){return this.db.prepare(`
      SELECT title, subtitle, type, prompt_number
      FROM observations
      WHERE sdk_session_id = ?
      ORDER BY created_at_epoch ASC
    `).all(e)}getObservationById(e){return this.db.prepare(`
      SELECT *
      FROM observations
      WHERE id = ?
    `).get(e)||null}getObservationsByIds(e,t={}){if(e.length===0)return[];let{orderBy:r="date_desc",limit:n,project:i,type:o,concepts:a,files:c}=t,l=r==="date_asc"?"ASC":"DESC",p=n?`LIMIT ${n}`:"",f=e.map(()=>"?").join(","),_=[...e],u=[];if(i&&(u.push("project = ?"),_.push(i)),o)if(Array.isArray(o)){let h=o.map(()=>"?").join(",");u.push(`type IN (${h})`),_.push(...o)}else u.push("type = ?"),_.push(o);if(a){let h=Array.isArray(a)?a:[a],C=h.map(()=>"EXISTS (SELECT 1 FROM json_each(concepts) WHERE value = ?)");_.push(...h),u.push(`(${C.join(" OR ")})`)}if(c){let h=Array.isArray(c)?c:[c],C=h.map(()=>"(EXISTS (SELECT 1 FROM json_each(files_read) WHERE value LIKE ?) OR EXISTS (SELECT 1 FROM json_each(files_modified) WHERE value LIKE ?))");h.forEach(L=>{_.push(`%${L}%`,`%${L}%`)}),u.push(`(${C.join(" OR ")})`)}let y=u.length>0?`WHERE id IN (${f}) AND ${u.join(" AND ")}`:`WHERE id IN (${f})`;return this.db.prepare(`
      SELECT *
      FROM observations
      ${y}
      ORDER BY created_at_epoch ${l}
      ${p}
    `).all(..._)}getSummaryForSession(e){return this.db.prepare(`
      SELECT
        request, investigated, learned, completed, next_steps,
        files_read, files_edited, notes, prompt_number, created_at
      FROM session_summaries
      WHERE sdk_session_id = ?
      ORDER BY created_at_epoch DESC
      LIMIT 1
    `).get(e)||null}getFilesForSession(e){let r=this.db.prepare(`
      SELECT files_read, files_modified
      FROM observations
      WHERE sdk_session_id = ?
    `).all(e),n=new Set,i=new Set;for(let o of r){if(o.files_read)try{let a=JSON.parse(o.files_read);Array.isArray(a)&&a.forEach(c=>n.add(c))}catch{}if(o.files_modified)try{let a=JSON.parse(o.files_modified);Array.isArray(a)&&a.forEach(c=>i.add(c))}catch{}}return{filesRead:Array.from(n),filesModified:Array.from(i)}}getSessionById(e){return this.db.prepare(`
      SELECT id, claude_session_id, sdk_session_id, project, user_prompt
      FROM sdk_sessions
      WHERE id = ?
      LIMIT 1
    `).get(e)||null}getSdkSessionsBySessionIds(e){if(e.length===0)return[];let t=e.map(()=>"?").join(",");return this.db.prepare(`
      SELECT id, claude_session_id, sdk_session_id, project, user_prompt,
             started_at, started_at_epoch, completed_at, completed_at_epoch, status
      FROM sdk_sessions
      WHERE sdk_session_id IN (${t})
      ORDER BY started_at_epoch DESC
    `).all(...e)}findActiveSDKSession(e){return this.db.prepare(`
      SELECT id, sdk_session_id, project, worker_port
      FROM sdk_sessions
      WHERE claude_session_id = ? AND status = 'active'
      LIMIT 1
    `).get(e)||null}findAnySDKSession(e){return this.db.prepare(`
      SELECT id
      FROM sdk_sessions
      WHERE claude_session_id = ?
      LIMIT 1
    `).get(e)||null}reactivateSession(e,t){this.db.prepare(`
      UPDATE sdk_sessions
      SET status = 'active', user_prompt = ?, worker_port = NULL
      WHERE id = ?
    `).run(t,e)}incrementPromptCounter(e){return this.db.prepare(`
      UPDATE sdk_sessions
      SET prompt_counter = COALESCE(prompt_counter, 0) + 1
      WHERE id = ?
    `).run(e),this.db.prepare(`
      SELECT prompt_counter FROM sdk_sessions WHERE id = ?
    `).get(e)?.prompt_counter||1}getPromptCounter(e){return this.db.prepare(`
      SELECT prompt_counter FROM sdk_sessions WHERE id = ?
    `).get(e)?.prompt_counter||0}createSDKSession(e,t,r){let n=new Date,i=n.getTime(),a=this.db.prepare(`
      INSERT OR IGNORE INTO sdk_sessions
      (claude_session_id, sdk_session_id, project, user_prompt, started_at, started_at_epoch, status)
      VALUES (?, ?, ?, ?, ?, ?, 'active')
    `).run(e,e,t,r,n.toISOString(),i);return a.lastInsertRowid===0||a.changes===0?(t&&t.trim()!==""&&this.db.prepare(`
          UPDATE sdk_sessions
          SET project = ?, user_prompt = ?
          WHERE claude_session_id = ?
        `).run(t,r,e),this.db.prepare(`
        SELECT id FROM sdk_sessions WHERE claude_session_id = ? LIMIT 1
      `).get(e).id):a.lastInsertRowid}updateSDKSessionId(e,t){return this.db.prepare(`
      UPDATE sdk_sessions
      SET sdk_session_id = ?
      WHERE id = ? AND sdk_session_id IS NULL
    `).run(t,e).changes===0?(N.debug("DB","sdk_session_id already set, skipping update",{sessionId:e,sdkSessionId:t}),!1):!0}setWorkerPort(e,t){this.db.prepare(`
      UPDATE sdk_sessions
      SET worker_port = ?
      WHERE id = ?
    `).run(t,e)}getWorkerPort(e){return this.db.prepare(`
      SELECT worker_port
      FROM sdk_sessions
      WHERE id = ?
      LIMIT 1
    `).get(e)?.worker_port||null}saveUserPrompt(e,t,r){let n=new Date,i=n.getTime();return this.db.prepare(`
      INSERT INTO user_prompts
      (claude_session_id, prompt_number, prompt_text, created_at, created_at_epoch)
      VALUES (?, ?, ?, ?, ?)
    `).run(e,t,r,n.toISOString(),i).lastInsertRowid}getUserPrompt(e,t){return this.db.prepare(`
      SELECT prompt_text
      FROM user_prompts
      WHERE claude_session_id = ? AND prompt_number = ?
      LIMIT 1
    `).get(e,t)?.prompt_text??null}storeObservation(e,t,r,n,i=0){let o=new Date,a=o.getTime();this.db.prepare(`
      SELECT id FROM sdk_sessions WHERE sdk_session_id = ?
    `).get(e)||(this.db.prepare(`
        INSERT INTO sdk_sessions
        (claude_session_id, sdk_session_id, project, started_at, started_at_epoch, status)
        VALUES (?, ?, ?, ?, ?, 'active')
      `).run(e,e,t,o.toISOString(),a),console.log(`[SessionStore] Auto-created session record for session_id: ${e}`));let f=this.db.prepare(`
      INSERT INTO observations
      (sdk_session_id, project, type, title, subtitle, facts, narrative, concepts,
       files_read, files_modified, prompt_number, discovery_tokens, created_at, created_at_epoch)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(e,t,r.type,r.title,r.subtitle,JSON.stringify(r.facts),r.narrative,JSON.stringify(r.concepts),JSON.stringify(r.files_read),JSON.stringify(r.files_modified),n||null,i,o.toISOString(),a);return{id:Number(f.lastInsertRowid),createdAtEpoch:a}}storeSummary(e,t,r,n,i=0){let o=new Date,a=o.getTime();this.db.prepare(`
      SELECT id FROM sdk_sessions WHERE sdk_session_id = ?
    `).get(e)||(this.db.prepare(`
        INSERT INTO sdk_sessions
        (claude_session_id, sdk_session_id, project, started_at, started_at_epoch, status)
        VALUES (?, ?, ?, ?, ?, 'active')
      `).run(e,e,t,o.toISOString(),a),console.log(`[SessionStore] Auto-created session record for session_id: ${e}`));let f=this.db.prepare(`
      INSERT INTO session_summaries
      (sdk_session_id, project, request, investigated, learned, completed,
       next_steps, notes, prompt_number, discovery_tokens, created_at, created_at_epoch)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(e,t,r.request,r.investigated,r.learned,r.completed,r.next_steps,r.notes,n||null,i,o.toISOString(),a);return{id:Number(f.lastInsertRowid),createdAtEpoch:a}}markSessionCompleted(e){let t=new Date,r=t.getTime();this.db.prepare(`
      UPDATE sdk_sessions
      SET status = 'completed', completed_at = ?, completed_at_epoch = ?
      WHERE id = ?
    `).run(t.toISOString(),r,e)}markSessionFailed(e){let t=new Date,r=t.getTime();this.db.prepare(`
      UPDATE sdk_sessions
      SET status = 'failed', completed_at = ?, completed_at_epoch = ?
      WHERE id = ?
    `).run(t.toISOString(),r,e)}getSessionSummariesByIds(e,t={}){if(e.length===0)return[];let{orderBy:r="date_desc",limit:n,project:i}=t,o=r==="date_asc"?"ASC":"DESC",a=n?`LIMIT ${n}`:"",c=e.map(()=>"?").join(","),l=[...e],p=i?`WHERE id IN (${c}) AND project = ?`:`WHERE id IN (${c})`;return i&&l.push(i),this.db.prepare(`
      SELECT * FROM session_summaries
      ${p}
      ORDER BY created_at_epoch ${o}
      ${a}
    `).all(...l)}getUserPromptsByIds(e,t={}){if(e.length===0)return[];let{orderBy:r="date_desc",limit:n,project:i}=t,o=r==="date_asc"?"ASC":"DESC",a=n?`LIMIT ${n}`:"",c=e.map(()=>"?").join(","),l=[...e],p=i?"AND s.project = ?":"";return i&&l.push(i),this.db.prepare(`
      SELECT
        up.*,
        s.project,
        s.sdk_session_id
      FROM user_prompts up
      JOIN sdk_sessions s ON up.claude_session_id = s.claude_session_id
      WHERE up.id IN (${c}) ${p}
      ORDER BY up.created_at_epoch ${o}
      ${a}
    `).all(...l)}getTimelineAroundTimestamp(e,t=10,r=10,n){return this.getTimelineAroundObservation(null,e,t,r,n)}getTimelineAroundObservation(e,t,r=10,n=10,i){let o=i?"AND project = ?":"",a=i?[i]:[],c,l;if(e!==null){let u=`
        SELECT id, created_at_epoch
        FROM observations
        WHERE id <= ? ${o}
        ORDER BY id DESC
        LIMIT ?
      `,y=`
        SELECT id, created_at_epoch
        FROM observations
        WHERE id >= ? ${o}
        ORDER BY id ASC
        LIMIT ?
      `;try{let S=this.db.prepare(u).all(e,...a,r+1),h=this.db.prepare(y).all(e,...a,n+1);if(S.length===0&&h.length===0)return{observations:[],sessions:[],prompts:[]};c=S.length>0?S[S.length-1].created_at_epoch:t,l=h.length>0?h[h.length-1].created_at_epoch:t}catch(S){return console.error("[SessionStore] Error getting boundary observations:",S.message,i?`(project: ${i})`:"(all projects)"),{observations:[],sessions:[],prompts:[]}}}else{let u=`
        SELECT created_at_epoch
        FROM observations
        WHERE created_at_epoch <= ? ${o}
        ORDER BY created_at_epoch DESC
        LIMIT ?
      `,y=`
        SELECT created_at_epoch
        FROM observations
        WHERE created_at_epoch >= ? ${o}
        ORDER BY created_at_epoch ASC
        LIMIT ?
      `;try{let S=this.db.prepare(u).all(t,...a,r),h=this.db.prepare(y).all(t,...a,n+1);if(S.length===0&&h.length===0)return{observations:[],sessions:[],prompts:[]};c=S.length>0?S[S.length-1].created_at_epoch:t,l=h.length>0?h[h.length-1].created_at_epoch:t}catch(S){return console.error("[SessionStore] Error getting boundary timestamps:",S.message,i?`(project: ${i})`:"(all projects)"),{observations:[],sessions:[],prompts:[]}}}let p=`
      SELECT *
      FROM observations
      WHERE created_at_epoch >= ? AND created_at_epoch <= ? ${o}
      ORDER BY created_at_epoch ASC
    `,f=`
      SELECT *
      FROM session_summaries
      WHERE created_at_epoch >= ? AND created_at_epoch <= ? ${o}
      ORDER BY created_at_epoch ASC
    `,_=`
      SELECT up.*, s.project, s.sdk_session_id
      FROM user_prompts up
      JOIN sdk_sessions s ON up.claude_session_id = s.claude_session_id
      WHERE up.created_at_epoch >= ? AND up.created_at_epoch <= ? ${o.replace("project","s.project")}
      ORDER BY up.created_at_epoch ASC
    `;try{let u=this.db.prepare(p).all(c,l,...a),y=this.db.prepare(f).all(c,l,...a),S=this.db.prepare(_).all(c,l,...a);return{observations:u,sessions:y.map(h=>({id:h.id,sdk_session_id:h.sdk_session_id,project:h.project,request:h.request,completed:h.completed,next_steps:h.next_steps,created_at:h.created_at,created_at_epoch:h.created_at_epoch})),prompts:S.map(h=>({id:h.id,claude_session_id:h.claude_session_id,prompt_number:h.prompt_number,prompt_text:h.prompt_text,project:h.project,created_at:h.created_at,created_at_epoch:h.created_at_epoch}))}}catch(u){return console.error("[SessionStore] Error querying timeline records:",u.message,i?`(project: ${i})`:"(all projects)"),{observations:[],sessions:[],prompts:[]}}}getPromptById(e){return this.db.prepare(`
      SELECT
        p.id,
        p.claude_session_id,
        p.prompt_number,
        p.prompt_text,
        s.project,
        p.created_at,
        p.created_at_epoch
      FROM user_prompts p
      LEFT JOIN sdk_sessions s ON p.claude_session_id = s.claude_session_id
      WHERE p.id = ?
      LIMIT 1
    `).get(e)||null}getPromptsByIds(e){if(e.length===0)return[];let t=e.map(()=>"?").join(",");return this.db.prepare(`
      SELECT
        p.id,
        p.claude_session_id,
        p.prompt_number,
        p.prompt_text,
        s.project,
        p.created_at,
        p.created_at_epoch
      FROM user_prompts p
      LEFT JOIN sdk_sessions s ON p.claude_session_id = s.claude_session_id
      WHERE p.id IN (${t})
      ORDER BY p.created_at_epoch DESC
    `).all(...e)}getSessionSummaryById(e){return this.db.prepare(`
      SELECT
        id,
        sdk_session_id,
        claude_session_id,
        project,
        user_prompt,
        request_summary,
        learned_summary,
        status,
        created_at,
        created_at_epoch
      FROM sdk_sessions
      WHERE id = ?
      LIMIT 1
    `).get(e)||null}close(){this.db.close()}importSdkSession(e){let t=this.db.prepare("SELECT id FROM sdk_sessions WHERE claude_session_id = ?").get(e.claude_session_id);return t?{imported:!1,id:t.id}:{imported:!0,id:this.db.prepare(`
      INSERT INTO sdk_sessions (
        claude_session_id, sdk_session_id, project, user_prompt,
        started_at, started_at_epoch, completed_at, completed_at_epoch, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(e.claude_session_id,e.sdk_session_id,e.project,e.user_prompt,e.started_at,e.started_at_epoch,e.completed_at,e.completed_at_epoch,e.status).lastInsertRowid}}importSessionSummary(e){let t=this.db.prepare("SELECT id FROM session_summaries WHERE sdk_session_id = ?").get(e.sdk_session_id);return t?{imported:!1,id:t.id}:{imported:!0,id:this.db.prepare(`
      INSERT INTO session_summaries (
        sdk_session_id, project, request, investigated, learned,
        completed, next_steps, files_read, files_edited, notes,
        prompt_number, discovery_tokens, created_at, created_at_epoch
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(e.sdk_session_id,e.project,e.request,e.investigated,e.learned,e.completed,e.next_steps,e.files_read,e.files_edited,e.notes,e.prompt_number,e.discovery_tokens||0,e.created_at,e.created_at_epoch).lastInsertRowid}}importObservation(e){let t=this.db.prepare(`
      SELECT id FROM observations
      WHERE sdk_session_id = ? AND title = ? AND created_at_epoch = ?
    `).get(e.sdk_session_id,e.title,e.created_at_epoch);return t?{imported:!1,id:t.id}:{imported:!0,id:this.db.prepare(`
      INSERT INTO observations (
        sdk_session_id, project, text, type, title, subtitle,
        facts, narrative, concepts, files_read, files_modified,
        prompt_number, discovery_tokens, created_at, created_at_epoch
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(e.sdk_session_id,e.project,e.text,e.type,e.title,e.subtitle,e.facts,e.narrative,e.concepts,e.files_read,e.files_modified,e.prompt_number,e.discovery_tokens||0,e.created_at,e.created_at_epoch).lastInsertRowid}}importUserPrompt(e){let t=this.db.prepare(`
      SELECT id FROM user_prompts
      WHERE claude_session_id = ? AND prompt_number = ?
    `).get(e.claude_session_id,e.prompt_number);return t?{imported:!1,id:t.id}:{imported:!0,id:this.db.prepare(`
      INSERT INTO user_prompts (
        claude_session_id, prompt_number, prompt_text,
        created_at, created_at_epoch
      ) VALUES (?, ?, ?, ?, ?)
    `).run(e.claude_session_id,e.prompt_number,e.prompt_text,e.created_at,e.created_at_epoch).lastInsertRowid}}};ot();Ee();xe();var lt=rt(require("path"),1);function dt(s){if(!s)return[];try{let e=JSON.parse(s);return Array.isArray(e)?e:[]}catch{return[]}}function Ps(s){return new Date(s).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}function Us(s){return new Date(s).toLocaleString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}function Bs(s){return new Date(s).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric"})}function Yn(s,e){return lt.default.isAbsolute(s)?lt.default.relative(e,s):s}function Fs(s,e){let t=dt(s);return t.length>0?Yn(t[0],e):"General"}var _s=null;async function lc(){if(!_s){let{query:s}=await Promise.resolve().then(()=>(xn(),kn));_s=s}return _s}function dc(){let s=process.env.CLAUDE_MEM_DATABASE?.toLowerCase();return s==="postgres"||s==="postgresql"}var pc=Ie.default.join((0,Ze.homedir)(),".claude","plugins","marketplaces","thedotmack","plugin",".install-version");function hc(){let s=Ie.default.join((0,Ze.homedir)(),".claude-mem","settings.json"),e=W.loadFromFile(s);try{return{totalObservationCount:parseInt(e.CLAUDE_MEM_CONTEXT_OBSERVATIONS,10),fullObservationCount:parseInt(e.CLAUDE_MEM_CONTEXT_FULL_COUNT,10),sessionCount:parseInt(e.CLAUDE_MEM_CONTEXT_SESSION_COUNT,10),showReadTokens:e.CLAUDE_MEM_CONTEXT_SHOW_READ_TOKENS==="true",showWorkTokens:e.CLAUDE_MEM_CONTEXT_SHOW_WORK_TOKENS==="true",showSavingsAmount:e.CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_AMOUNT==="true",showSavingsPercent:e.CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_PERCENT==="true",observationTypes:new Set(e.CLAUDE_MEM_CONTEXT_OBSERVATION_TYPES.split(",").map(t=>t.trim()).filter(Boolean)),observationConcepts:new Set(e.CLAUDE_MEM_CONTEXT_OBSERVATION_CONCEPTS.split(",").map(t=>t.trim()).filter(Boolean)),fullObservationField:e.CLAUDE_MEM_CONTEXT_FULL_FIELD,showLastSummary:e.CLAUDE_MEM_CONTEXT_SHOW_LAST_SUMMARY==="true",showLastMessage:e.CLAUDE_MEM_CONTEXT_SHOW_LAST_MESSAGE==="true"}}catch(t){return N.warn("WORKER","Failed to load context settings, using defaults",{},t),{totalObservationCount:50,fullObservationCount:5,sessionCount:10,showReadTokens:!0,showWorkTokens:!0,showSavingsAmount:!0,showSavingsPercent:!0,observationTypes:new Set(nt),observationConcepts:new Set(it),fullObservationField:"narrative",showLastSummary:!0,showLastMessage:!1}}}var Pn=4,Un=1,d={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",cyan:"\x1B[36m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",gray:"\x1B[90m",red:"\x1B[31m"};function ze(s,e,t,r){return e?r?[`${t}${s}:${d.reset} ${e}`,""]:[`**${s}**: ${e}`,""]:[]}function fc(s){return s.replace(/\//g,"-")}function mc(s){try{if(!(0,me.existsSync)(s))return{userMessage:"",assistantMessage:""};let e=(0,me.readFileSync)(s,"utf-8").trim();if(!e)return{userMessage:"",assistantMessage:""};let t=e.split(`
`).filter(n=>n.trim()),r="";for(let n=t.length-1;n>=0;n--)try{let i=t[n];if(!i.includes('"type":"assistant"'))continue;let o=JSON.parse(i);if(o.type==="assistant"&&o.message?.content&&Array.isArray(o.message.content)){let a="";for(let c of o.message.content)c.type==="text"&&(a+=c.text);if(a=a.replace(/<system-reminder>[\s\S]*?<\/system-reminder>/g,"").trim(),a){r=a;break}}}catch{continue}return{userMessage:"",assistantMessage:r}}catch(e){return N.failure("WORKER","Failed to extract prior messages from transcript",{transcriptPath:s},e),{userMessage:"",assistantMessage:""}}}async function _c(s,e=!1){let t=hc(),r=s?.cwd??process.cwd(),n=r?Ie.default.basename(r):"unknown-project",i,o,a=Array.from(t.observationTypes),c=Array.from(t.observationConcepts);if(dc()){let y=await lc(),S=1,h=[],C=a.map(()=>`$${S++}`).join(",");h.push(...a);let L=c.map(()=>`$${S++}`).join(",");h.push(...c),i=(await y(`
      SELECT
        id, sdk_session_id, type, title, subtitle, narrative,
        facts, concepts, files_read, files_modified, discovery_tokens,
        created_at, created_at_epoch
      FROM observations
      WHERE project = $${S++}
        AND type IN (${C})
        AND EXISTS (
          SELECT 1 FROM jsonb_array_elements_text(concepts) AS elem
          WHERE elem IN (${L})
        )
      ORDER BY created_at_epoch DESC
      LIMIT $${S}
    `,[...h,n,t.totalObservationCount])).rows.map(T=>({...T,created_at_epoch:typeof T.created_at_epoch=="string"?parseInt(T.created_at_epoch,10):T.created_at_epoch,facts:Array.isArray(T.facts)?JSON.stringify(T.facts):T.facts,concepts:Array.isArray(T.concepts)?JSON.stringify(T.concepts):T.concepts,files_read:Array.isArray(T.files_read)?JSON.stringify(T.files_read):T.files_read,files_modified:Array.isArray(T.files_modified)?JSON.stringify(T.files_modified):T.files_modified})),o=(await y(`
      SELECT id, sdk_session_id, request, investigated, learned, completed, next_steps, created_at, created_at_epoch
      FROM session_summaries
      WHERE project = $1
      ORDER BY created_at_epoch DESC
      LIMIT $2
    `,[n,t.sessionCount+Un])).rows.map(T=>({...T,created_at_epoch:typeof T.created_at_epoch=="string"?parseInt(T.created_at_epoch,10):T.created_at_epoch}))}else{let y=null;try{y=new Pe}catch(C){if(C.code==="ERR_DLOPEN_FAILED"){try{(0,me.unlinkSync)(pc)}catch{}return console.error("Native module rebuild needed - restart Claude Code to auto-fix"),""}throw C}let S=a.map(()=>"?").join(","),h=c.map(()=>"?").join(",");i=y.db.prepare(`
      SELECT
        id, sdk_session_id, type, title, subtitle, narrative,
        facts, concepts, files_read, files_modified, discovery_tokens,
        created_at, created_at_epoch
      FROM observations
      WHERE project = ?
        AND type IN (${S})
        AND EXISTS (
          SELECT 1 FROM json_each(concepts)
          WHERE value IN (${h})
        )
      ORDER BY created_at_epoch DESC
      LIMIT ?
    `).all(n,...a,...c,t.totalObservationCount),o=y.db.prepare(`
      SELECT id, sdk_session_id, request, investigated, learned, completed, next_steps, created_at, created_at_epoch
      FROM session_summaries
      WHERE project = ?
      ORDER BY created_at_epoch DESC
      LIMIT ?
    `).all(n,t.sessionCount+Un)}let l="",p="";if(t.showLastMessage&&i.length>0)try{let y=s?.session_id,S=i.find(h=>h.sdk_session_id!==y);if(S){let h=S.sdk_session_id,C=fc(r),L=Ie.default.join((0,Ze.homedir)(),".claude","projects",C,`${h}.jsonl`),P=mc(L);l=P.userMessage,p=P.assistantMessage}}catch{}if(i.length===0&&o.length===0)return e?`
${d.bright}${d.cyan}[${n}] recent context${d.reset}
${d.gray}${"\u2500".repeat(60)}${d.reset}

${d.dim}No previous sessions found for this project yet.${d.reset}
`:`# [${n}] recent context

No previous sessions found for this project yet.`;let f=o.slice(0,t.sessionCount),_=i,u=[];if(e?(u.push(""),u.push(`${d.bright}${d.cyan}[${n}] recent context${d.reset}`),u.push(`${d.gray}${"\u2500".repeat(60)}${d.reset}`),u.push("")):(u.push(`# [${n}] recent context`),u.push("")),_.length>0){e?u.push(`${d.dim}Legend: \u{1F3AF} session-request | \u{1F534} bugfix | \u{1F7E3} feature | \u{1F504} refactor | \u2705 change | \u{1F535} discovery | \u2696\uFE0F  decision${d.reset}`):u.push("**Legend:** \u{1F3AF} session-request | \u{1F534} bugfix | \u{1F7E3} feature | \u{1F504} refactor | \u2705 change | \u{1F535} discovery | \u2696\uFE0F  decision"),u.push(""),e?(u.push(`${d.bright}\u{1F4A1} Column Key${d.reset}`),u.push(`${d.dim}  Read: Tokens to read this observation (cost to learn it now)${d.reset}`),u.push(`${d.dim}  Work: Tokens spent on work that produced this record (\u{1F50D} research, \u{1F6E0}\uFE0F building, \u2696\uFE0F  deciding)${d.reset}`)):(u.push("\u{1F4A1} **Column Key**:"),u.push("- **Read**: Tokens to read this observation (cost to learn it now)"),u.push("- **Work**: Tokens spent on work that produced this record (\u{1F50D} research, \u{1F6E0}\uFE0F building, \u2696\uFE0F  deciding)")),u.push(""),e?(u.push(`${d.dim}\u{1F4A1} Context Index: This semantic index (titles, types, files, tokens) is usually sufficient to understand past work.${d.reset}`),u.push(""),u.push(`${d.dim}When you need implementation details, rationale, or debugging context:${d.reset}`),u.push(`${d.dim}  - Use the mem-search skill to fetch full observations on-demand${d.reset}`),u.push(`${d.dim}  - Critical types (\u{1F534} bugfix, \u2696\uFE0F decision) often need detailed fetching${d.reset}`),u.push(`${d.dim}  - Trust this index over re-reading code for past decisions and learnings${d.reset}`)):(u.push("\u{1F4A1} **Context Index:** This semantic index (titles, types, files, tokens) is usually sufficient to understand past work."),u.push(""),u.push("When you need implementation details, rationale, or debugging context:"),u.push("- Use the mem-search skill to fetch full observations on-demand"),u.push("- Critical types (\u{1F534} bugfix, \u2696\uFE0F decision) often need detailed fetching"),u.push("- Trust this index over re-reading code for past decisions and learnings")),u.push("");let y=i.length,S=i.reduce((E,O)=>{let I=(O.title?.length||0)+(O.subtitle?.length||0)+(O.narrative?.length||0)+JSON.stringify(O.facts||[]).length;return E+Math.ceil(I/Pn)},0),h=i.reduce((E,O)=>E+(O.discovery_tokens||0),0),C=h-S,L=h>0?Math.round(C/h*100):0,P=t.showReadTokens||t.showWorkTokens||t.showSavingsAmount||t.showSavingsPercent;if(P)if(e){if(u.push(`${d.bright}${d.cyan}\u{1F4CA} Context Economics${d.reset}`),u.push(`${d.dim}  Loading: ${y} observations (${S.toLocaleString()} tokens to read)${d.reset}`),u.push(`${d.dim}  Work investment: ${h.toLocaleString()} tokens spent on research, building, and decisions${d.reset}`),h>0&&(t.showSavingsAmount||t.showSavingsPercent)){let E="  Your savings: ";t.showSavingsAmount&&t.showSavingsPercent?E+=`${C.toLocaleString()} tokens (${L}% reduction from reuse)`:t.showSavingsAmount?E+=`${C.toLocaleString()} tokens`:E+=`${L}% reduction from reuse`,u.push(`${d.green}${E}${d.reset}`)}u.push("")}else{if(u.push("\u{1F4CA} **Context Economics**:"),u.push(`- Loading: ${y} observations (${S.toLocaleString()} tokens to read)`),u.push(`- Work investment: ${h.toLocaleString()} tokens spent on research, building, and decisions`),h>0&&(t.showSavingsAmount||t.showSavingsPercent)){let E="- Your savings: ";t.showSavingsAmount&&t.showSavingsPercent?E+=`${C.toLocaleString()} tokens (${L}% reduction from reuse)`:t.showSavingsAmount?E+=`${C.toLocaleString()} tokens`:E+=`${L}% reduction from reuse`,u.push(E)}u.push("")}let we=o[0]?.id,T=f.map((E,O)=>{let I=O===0?null:o[O+1];return{...E,displayEpoch:I?I.created_at_epoch:E.created_at_epoch,displayTime:I?I.created_at:E.created_at,shouldShowLink:E.id!==we}}),Bn=new Set(i.slice(0,t.fullObservationCount).map(E=>E.id)),Es=[..._.map(E=>({type:"observation",data:E})),...T.map(E=>({type:"summary",data:E}))];Es.sort((E,O)=>{let I=E.type==="observation"?E.data.created_at_epoch:E.data.displayEpoch,G=O.type==="observation"?O.data.created_at_epoch:O.data.displayEpoch;return I-G});let Le=new Map;for(let E of Es){let O=E.type==="observation"?E.data.created_at:E.data.displayTime,I=Bs(O);Le.has(I)||Le.set(I,[]),Le.get(I).push(E)}let Fn=Array.from(Le.entries()).sort((E,O)=>{let I=new Date(E[0]).getTime(),G=new Date(O[0]).getTime();return I-G});for(let[E,O]of Fn){e?(u.push(`${d.bright}${d.cyan}${E}${d.reset}`),u.push("")):(u.push(`### ${E}`),u.push(""));let I=null,G="",J=!1;for(let et of O)if(et.type==="summary"){J&&(u.push(""),J=!1,I=null,G="");let R=et.data,z=`${R.request||"Session started"} (${Ps(R.displayTime)})`;e?u.push(`\u{1F3AF} ${d.yellow}#S${R.id}${d.reset} ${z}`):u.push(`**\u{1F3AF} #S${R.id}** ${z}`),u.push("")}else{let R=et.data,z=Fs(R.files_modified,r);z!==I&&(J&&u.push(""),e?u.push(`${d.dim}${z}${d.reset}`):u.push(`**${z}**`),e||(u.push("| ID | Time | T | Title | Read | Work |"),u.push("|----|------|---|-------|------|------|")),I=z,J=!0,G="");let Z=Us(R.created_at),Ne=R.title||"Untitled",Me=As[R.type]||"\u2022",$n=(R.title?.length||0)+(R.subtitle?.length||0)+(R.narrative?.length||0)+JSON.stringify(R.facts||[]).length,se=Math.ceil($n/Pn),re=R.discovery_tokens||0,tt=vs[R.type]||"\u{1F50D}",Ss=re>0?`${tt} ${re.toLocaleString()}`:"-",st=Z!==G,ys=st?Z:"";if(G=Z,Bn.has(R.id)){let X=t.fullObservationField==="narrative"?R.narrative:R.facts?dt(R.facts).join(`
`):null;if(e){let j=st?`${d.dim}${Z}${d.reset}`:" ".repeat(Z.length),De=t.showReadTokens&&se>0?`${d.dim}(~${se}t)${d.reset}`:"",Ts=t.showWorkTokens&&re>0?`${d.dim}(${tt} ${re.toLocaleString()}t)${d.reset}`:"";u.push(`  ${d.dim}#${R.id}${d.reset}  ${j}  ${Me}  ${d.bright}${Ne}${d.reset}`),X&&u.push(`    ${d.dim}${X}${d.reset}`),(De||Ts)&&u.push(`    ${De} ${Ts}`),u.push("")}else{J&&(u.push(""),J=!1),u.push(`**#${R.id}** ${ys||"\u2033"} ${Me} **${Ne}**`),X&&(u.push(""),u.push(X),u.push(""));let j=[];t.showReadTokens&&j.push(`Read: ~${se}`),t.showWorkTokens&&j.push(`Work: ${Ss}`),j.length>0&&u.push(j.join(", ")),u.push(""),I=null}}else if(e){let X=st?`${d.dim}${Z}${d.reset}`:" ".repeat(Z.length),j=t.showReadTokens&&se>0?`${d.dim}(~${se}t)${d.reset}`:"",De=t.showWorkTokens&&re>0?`${d.dim}(${tt} ${re.toLocaleString()}t)${d.reset}`:"";u.push(`  ${d.dim}#${R.id}${d.reset}  ${X}  ${Me}  ${Ne} ${j} ${De}`)}else{let X=t.showReadTokens?`~${se}`:"",j=t.showWorkTokens?Ss:"";u.push(`| #${R.id} | ${ys||"\u2033"} | ${Me} | ${Ne} | ${X} | ${j} |`)}}J&&u.push("")}let q=o[0],gs=i[0];if(t.showLastSummary&&q&&(q.investigated||q.learned||q.completed||q.next_steps)&&(!gs||q.created_at_epoch>gs.created_at_epoch)&&(u.push(...ze("Investigated",q.investigated,d.blue,e)),u.push(...ze("Learned",q.learned,d.yellow,e)),u.push(...ze("Completed",q.completed,d.green,e)),u.push(...ze("Next Steps",q.next_steps,d.magenta,e))),p&&(u.push(""),u.push("---"),u.push(""),e?(u.push(`${d.bright}${d.magenta}\u{1F4CB} Previously${d.reset}`),u.push(""),u.push(`${d.dim}A: ${p}${d.reset}`)):(u.push("**\u{1F4CB} Previously**"),u.push(""),u.push(`A: ${p}`)),u.push("")),P&&h>0&&C>0){let E=Math.round(h/1e3);u.push(""),e?u.push(`${d.dim}\u{1F4B0} Access ${E}k tokens of past research & decisions for just ${S.toLocaleString()}t. Use the mem-search skill to access memories by ID instead of re-reading files.${d.reset}`):u.push(`\u{1F4B0} Access ${E}k tokens of past research & decisions for just ${S.toLocaleString()}t. Use the mem-search skill to access memories by ID instead of re-reading files.`)}}return u.join(`
`).trimEnd()}0&&(module.exports={generateContext});
